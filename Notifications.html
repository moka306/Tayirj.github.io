<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مرجان - الإشعارات</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- إضافة Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        /* ============ الإعدادات العامة والهيكل الأساسي ============ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Tajawal', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            padding-bottom: 80px; /* إضافة حشوة سفلية للشريط */
        }
        
        .container {
            width: 100%;
            max-width: 100%;
            margin: 0;
            padding: 0;
            flex: 1;
            display: flex;
        }
        
        /* ============ قسم الإشعارات ============ */
        .notifications-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            margin: 0;
            border-radius: 0;
            box-shadow: none;
            flex: 1;
            min-height: calc(100vh - 30px);
            display: flex;
            flex-direction: column;
            width: 100%;
        }
        #notif-image {
            width: 100%;
            max-width: 100%;
            height: 150px; /* ارتفاع ثابت للصورة */
            object-fit: cover; /* تغطية المساحة مع الحفاظ على التناسب */
            border-radius: 12px 12px 0 0; /* زوايا دائرية من الأعلى فقط */
            margin-bottom: 15px;
            display: block;
        }
        #notif-message {
            max-height: 150px; /* تحديد ارتفاع ثابت */
            overflow-y: auto; /* إضافة شريط تمرير عند الحاجة */
            line-height: 1;
            padding: 10px;
            border: 1px solid #f0f0f0;
            border-radius: 8px;
            background: #f9f9f9;
            margin: 10px 0;
            width: 105%;
            
        }
        
        .notifications-title {
            text-align: center;
            margin-bottom: 30px;
            color: #1a2a6c;
            font-size: 1.8rem;
            position: relative;
            padding-bottom: 15px;
        }
        
        
        .notifications-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 150px;
            height: 4px;
            background: linear-gradient(to right, #ff8c00, #ff4500);
            border-radius: 2px;
        }
        .notification-text {
            font-weight: 500;
            color: #333;
            margin-bottom: 5px;
            display: -webkit-box;
            -webkit-line-clamp: 2; /* عدد الأسعار المراد عرضها */
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.4; /* تحسين المسافة بين الأسطر */
            max-height: 4.2em; /* تقريباً 3 أسطر بارتفاع 1.4 */
        }
        .notification-item.unread::before {
            content: "";
            position: absolute;
            right: 10px; /* الموضع من اليمين */
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            background-color: #ff4757; /* لون أحمر */
            border-radius: 50%;
        }

        .notification-item.unread {
            padding-right: 25px; /* زيادة المساحة للعلامة الحمراء */
        }
        .notification-item.unread::before {
            width: 10px;
            height: 10px;
            background-color: #ff3838;
            box-shadow: 0 0 5px rgba(255, 56, 56, 0.7); /* تأثير متوهج */
            right: 12px;
        }

        .notification-text {
            font-weight: 500;
            color: #333;
            margin-bottom: 5px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-clamp: 2; /* للدعم الحديث */
            box-orient: vertical;
            line-height: 1.4;
            max-height: 4.2em;
        }
        /* ============ التصميم الكلاسيكي للإشعارات ============ */
        .notification-list {
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            padding: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .notification-item {
            display: flex;
            align-items: center; /* محاذاة المحتوى لأعلى */
            background: transparent;
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
            position: relative; /* لجعل الزر المطلق يعتمد على هذا العنصر */
            padding-left: 50px; /* إضافة مساحة للزر على اليسار */
            
            align-items: center;
            background: transparent;
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
        }
        
        .notification-item:last-child {
            border-bottom: none;
        }
        
        .notification-item:hover {
            background-color: #f8f9fa;
        }
        
        .notification-icon {
            width: 50px;
            height: 50px;
            background: #666;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 15px;
            flex-shrink: 0;
           
        }
        
        .notification-icon i {
            color: white;
            font-size: 1.4rem;
        }
        
        .notification-content {
            max-width: calc(100% - 80px); /* تقليل العرض */
            padding-right: 8px; /* إضافة مساحة داخلية */
        }
        
        .notification-text {
            font-weight: 500;
            color: #333;
            margin-bottom: 5px;
        }
        
        .notification-time {
            font-size: 0.85rem;
            color: #777;
            display: flex;
            justify-content: space-between;
        }
        
        .notification-date {
            font-size: 0.8rem;
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        /* النافذة نفسها */
        .modal {
            background: #fff;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh; /* تحديد أقصى ارتفاع */
            overflow-y: hidden; /* منع التمرير *//* إمكانية التمرير إذا المحتوى طويل */
            padding: 0; /* إزالة الحشوة الداخلية */
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            position: relative;
            text-align: center;
            display: flex;
            flex-direction: column;
            padding: 0; /* تأكد من إزالة الحشوة من النافذة */
        }
        .modal-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* المحاذاة من الأعلى */
            padding: 24px; /* إضافة حشوة داخلية هنا بدلاً من الـ modal */
            width: 100%;
            padding-top: 0; /* إزالة الحشوة العليا */
            overflow-y: visible; /* السماح بمشاهدة المحتوى كاملاً */
            padding: 0; /* إزالة الحشوة الداخلية */
        }
        /* الصورة - التعديلات الرئيسية */
        
        
            
        

        #notif-image {
            margin: 0; /* إزالة جميع الهوامش */
        }
        
        .modal h2 {
            margin-top: 0;
            font-size: 1.5rem;
        }
        .modal p {
            margin: 16px 0;
            line-height: 1.6;
        }
        .modal img {
            width: 120px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            background: #f1f1f1;
            display: block;
            margin: 16px auto;
        }
        .modal button.close {
            background: #1565d8;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
        }
       
        .center-button {
            background: linear-gradient(45deg, #1a2a6c, #4a6fc5);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(26, 42, 108, 0.3);
            margin: 20px 0;
        }
        .center-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(26, 42, 108, 0.4);
            background: linear-gradient(45deg, #4a6fc5, #1a2a6c);
        }
        
        
        .notification-delete {
            background: none;
            border: none;
            color: #777;
            font-size: 1rem; /* تصغير الحجم قليلاً */
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.2s ease;
            margin-left: 10px; /* نقل إلى اليسار */
            margin-right: 0; /* إزالة الهامش الأيمن */
            align-self: flex-start; /* محاذاة لأعلى */
            order: -1; /* جعله أول عنصر في الترتيب */
            position: absolute; /* تحديد الموضع */
            left: -5px; /* المسافة من اليسار */
            top: 5px; /* المسافة من الأعلى */
        }
        
        .notification-delete:hover {
            background: #f0f0f0;
            color: #d32f2f;
        }
        
        
        /* ألوان مختلفة للأيقونات حسب نوع الإشعار */
        .notification-item[data-type="follow"] .notification-icon {
            background: #4CAF50;
        }
        
        .notification-item[data-type="like"] .notification-icon {
            background: #E91E63;
        }
        
        .notification-item[data-type="system"] .notification-icon {
            background: #607D8B;
        }
        
        .notification-item[data-type="admin"] .notification-icon {
            background: #1a2a6c;
        }
        
        /* ============ الشريط السفلي الزجاجي المعدل ============ */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 25px 25px 0 0;
            padding: 12px 15px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -5px 25px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1000;
        }
        
        .nav-item {
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            font-size: 0.8rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 6px 12px;
            border-radius: 50px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .nav-item i {
            margin-bottom: 3px;
            font-size: 1.1rem;
            position: relative;
            z-index: 2;
        }
        
        .nav-item span {
            position: relative;
            z-index: 2;
        }
        
        .nav-item.active {
            color: #1a2a6c;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.6);
            border-radius: 50px;
            padding: 4px 15px;
        }
        
        .nav-item:not(.active):hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .nav-item::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
        }
        
        .nav-item:active::before {
            width: 300px;
            height: 300px;
        }
        /* شارة الإشعارات على عناصر التنقل */
        .nav-badge {
            position: absolute;
            top: 2px;
            right: 20px;
            background: linear-gradient(45deg, #ff4757, #ff3838);
            color: white;
            border-radius: 50%;
            width: 15px;
            height: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.5rem;
            font-weight: bold;
            box-shadow: 0 2px 6px rgba(255, 71, 87, 0.5);
            z-index: 3;
        }

        /* إخفاء الشارة عند عدم وجود رسائل */
        .nav-badge.hidden {
            display: none;
        }
        
        .add-center {
            background: linear-gradient(45deg, #ff8c00, #ff4500);
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            font-weight: bold;
            display: flex;
            align-items: center;
            box-shadow: 0 4px 12px rgba(255, 140, 0, 0.4);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            font-size: 0.8rem;
        }
        
        .add-center::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
        }
        
        .add-center:active::before {
            width: 300px;
            height: 300px;
        }
        
        .add-center:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 18px rgba(255, 140, 0, 0.5);
        }
        
        /* رسائل الحالة */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
        }
        
        /* ============ التصميم المتجاوب ============ */
        @media (max-width: 768px) {
            .notifications-container {
                padding: 20px;
                margin: 0;
                border-radius: 0;
            }
            
            .notifications-title {
                font-size: 1.5rem;
            }
            
            .notification-item {
                padding: 15px;
            }
            
            .notification-icon {
                width: 45px;
                height: 45px;
                margin-left: 12px;
            }
            
            .notification-icon i {
                font-size: 1.2rem;
            }
            
            /* تعديلات للشريط السفلي على الشاشات المتوسطة */
            .bottom-nav {
                padding: 10px 12px;
                border-radius: 20px 20px 0 0;
            }
            
            .nav-item {
                padding: 5px 8px;
                font-size: 0.7rem;
            }
            
            .nav-item i {
                font-size: 1rem;
            }
            
            .add-center {
                padding: 8px 16px;
                font-size: 0.8rem;
            }
        }
        
        @media (max-width: 480px) {
            #notif-video {
                max-height: 180px; /* زيادة من 150px إلى 180px */
                height: 170px; /* ارتفاع ثابت للشاشات الصغيرة */
                margin: 3px 0;
            }
            .video-thumbnail-container {
                width: 100%;
                height: 100%;
                position: relative;
                border-radius: 50%;
                overflow: hidden;
            }
            video-thumbnail {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }
            .notification-icon img {
                width: 100%;
                height: 100%;
                border-radius: 50%;
                object-fit: cover;
            }
            .video-icon-fallback {
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            }
            .video-play-icon {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.7);
                border-radius: 50%;
                width: 25px;
                height: 25px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .video-play-icon i {
                color: white;
                font-size: 0.8rem;
                margin-left: 2px;
            }

            .notification-title {
                font-weight: bold;
                color: #1a2a6c;
                margin-bottom: 1px;
                font-size: 0.9rem;
                line-height: 1.1;
            }

            .notification-text {
                color: #666;
                font-size: 0.1rem;
                line-height: 1.1;
            }
            #button-container {
                margin: -5px 0 !important; /* تقليل أكثر */
                
            }
            
            #notif-button {
                padding: 8px 16px !important;
                font-size: 0.75rem !important;
            }
            #notif-image {
                width: 100%;
                max-width: 100%;
                height: 150px; /* ارتفاع ثابت للصورة */
                object-fit: cover; /* تغطية المساحة مع الحفاظ على التناسب */
                border-radius: 12px 12px 0 0; /* زوايا دائرية من الأعلى فقط */
                margin-bottom: 15px;
                display: block;
            }
            #notif-message {
                max-height: 120px; /* تحديد ارتفاع ثابت */
                overflow-y: auto; /* إضافة شريط تمرير عند الحاجة */
                line-height: 1;
                padding: 10px;
                border: 1px solid #f0f0f0;
                border-radius: 8px;
                background: #f9f9f9;
                margin: 10px 0;
                width: 105%;
                
            }
            #notif-subtitle {
                margin-bottom: 5px !important; /* تقليل أكثر */
                font-size: 0.8rem !important; /* تقليل أكثر */
            }
            
            #notif-message {
                margin-top: 3px !important;
                margin-bottom: -5px !important;
                font-size: 0.8rem !important; /* تقليل أكثر */
            }

            .modal {
                width: 80%;
                max-width: 350px;
                padding: 0px;
                margin: 10px;
                max-height: 85vh;
            }
            
            .modal-content {
                min-height: 360px;
                padding: 7px;
            }
            #notif-image {
                width: 100%;
                max-width: 100%;
                height: 150px;
                object-fit: cover;
                border-radius: 12px 12px 0 0;
                margin-bottom: 15px; /* تقليل هذه القيمة */
                display: block;
            }
            
            .modal h2 {
                font-size: 1.3rem;
            }
            
            .modal p {
                font-size: 0.9rem;
                margin: 12px 0;
            }
            
            .center-button {
                margin-bottom: 1px !important;
               
                
            }
            #bottomNavCompetitions .nav-badge {
                top: 0.7
                px;
                right: 10px;
                width: 12.5px;
                height: 12.5px;
                font-size: 0.5rem;
            }
        


            .nav-badge {
                top: 6px;
                right: 12px;
                width: 13px;
                height: 13px;
                font-size: 0.5rem;
                top: 1px;
                right: 20px;
            }
            .notifications-title::after {
                width: 110px; /* تصغير أكثر */
            }
            .notification-text {
                font-size: 0.9rem; /* تصغير نص الرسالة */
                margin-bottom: 2px !important; /* تقليل الهامش أسفل النص */
            }
            
            
            .notification-item.unread::before {
                width: 8px;
                height: 8px;
                right: 8px;
            }
            
            .notification-item.unread {
                padding-right: 20px;
            }
            .notification-delete {
                margin-right: 5px;
                padding: 3px;
            }
            .notification-content {
                width: 100%;
                margin-left: 0;
                padding: 1px 0 !important;
                
            }


            .notifications-container {
                padding: 1px;
                margin: 0;
            }
            
            .notifications-title {
                font-size: 1.17rem;
                padding-bottom: 7px; /* تقليل أكثر */
                margin-top: 5px; /* زيادة الهامش الأعلى */
                padding-top: 8px; /* أو زيادة الحشوة الأعلى */
                margin-bottom: 20px; /* تقليل من 30px */
                
            }
            
            .notification-item {
                padding: 8px 10px; /* تقليل الحشوة أكثر */
            }
            
            .notification-icon {
                width: 50px;
                height: 50px;
                margin-left: 5px;
                margin-right: -7px;
            }
            
            .notification-icon i {
                font-size: 1.1rem;
            }
            
            .notification-time {
                flex-direction: column;
                gap: 3px;
                font-size: 0.75rem; /* تصغير وقت الإرسال */
                
            }
            
            /* تعديلات للشريط السفلي على الشاشات الصغيرة */
            .bottom-nav {
                padding: 3px 0px;
            }
            
            .nav-item {
                padding: 4px 6px;
                font-size: 0.65rem;
            }
            
            .nav-item i {
                font-size: 0.9rem;
            }
            
            .add-center {
                padding: 6px 12px;
                font-size: 0.7rem;
            }
        }
        
        @media (max-width: 350px) {
            .notifications-container {
               padding: 5px 0; /* إزالة الهوامش الجانبية تماماً */
            }
            
            .notification-item {
                padding: 10px;
            }
            
            .notification-icon {
                width: 35px;
                height: 35px;
                margin-left: 8px;
            }
            
            .notification-icon i {
                font-size: 1rem;
            }
            
            .notification-text {
                font-size: 0.9rem;
            }
            
            .notification-time {
                font-size: 0.75rem;
            }
            
            /* تعديلات للشريط السفلي على الشاشات الصغيرة جداً */
            .bottom-nav {
                padding: 6px 8px;
            }
            
            .nav-item {
                padding: 3px 5px;
                font-size: 0.6rem;
            }
            
            .nav-item i {
                font-size: 0.85rem;
            }
            
            .add-center {
                padding: 5px 10px;
                font-size: 0.6rem;
            }
        }
    </style>
</head>
<body>
    <!-- ============ قسم الإشعارات ============ -->
    <div class="container">
        <div class="notifications-container">
            <h2 class="notifications-title">الإشعارات</h2>
            
            <!-- قائمة الإشعارات -->
            <div class="notification-list" id="notificationsList">
                <!-- سيتم تحميل الإشعارات هنا ديناميكياً -->
                <div class="empty-state" id="emptyState">
                    <i class="fas fa-bell-slash"></i>
                    <p>لا توجد إشعارات</p>
                    <p style="font-size: 0.9rem; margin-top: 10px;">سيظهر هنا الإشعارات المرسلة من الإدارة</p>
                </div>
            </div>
        </div>
    </div>
    <!-- إضافة هذا العنصر قبل الشريط السفلي مباشرة -->
    <div class="notification-alert" id="notificationAlert">
        <i class="fas fa-bell"></i>
        <span>لديك إشعارات جديدة</span>
        <button class="close-alert" onclick="closeNotificationAlert()">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <!-- نافذة العرض المنبثقة -->
    <!-- نافذة تفاصيل الإشعار -->
    <!-- نافذة تفاصيل الإشعار -->
    <!-- النافذة المنبثقة الجديدة -->
    <!-- النافذة المنبثقة الجديدة -->
    <div id="notif-backdrop" class="modal-backdrop">
        <div class="modal">
            
            
            <!-- محتوى النافذة مع الترتيب الجديد -->
            <div class="modal-content">
                <!-- الصورة في البداية -->
                <img id="notif-image" src="" alt="صورة الإشعار" style="display: none; max-width: 100%; border-radius: 8px; margin-bottom: 15px;">
                
                <!-- العنوان -->
                <h3 id="notif-subtitle" style="display: none; margin-bottom: 15px; color: #1a2a6c;"></h3>
                
                <!-- الرسالة -->
                <p id="notif-message" style="margin: 15px 0; line-height: 1.6;"></p>
                
                <!-- زر اضغط هنا -->
                <div id="button-container" style="display: none; margin: 20px 0;">
                    <button id="notif-button" class="center-button" onclick="openNotificationUrl()">
                        اضغط هنا
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ============ الشريط السفلي الزجاجي المعدل ============ -->
    <nav class="bottom-nav">
        <a href="index.html" class="nav-item">
            <i class="fas fa-home"></i>
            <span>الرئيسية</span>
        </a>
        <a href="#" class="nav-item" id="bottomNavCompetitions">
            <i class="fas fa-gift"></i>
            <span>المسابقات</span>
            <div class="nav-badge hidden" id="chatBadge">0</div>
        </a>
        <a href="#" class="nav-item add-center" id="bottomNavAdd">
            <i class="fas fa-plus-circle"></i>
            <span>أضف إعلانك</span>
        </a>
        <a href="#" class="nav-item active" id="navNotifications">
            <i class="fas fa-bell"></i>
            <span>الإشعارات</span>
            <div class="nav-badge hidden" id="notificationsBadge">0</div>
        </a>
        <a href="#" class="nav-item" id="bottomNavAccount">
            <i class="fas fa-user"></i>
            <span>حسابي</span>
        </a>
    </nav>

    <script>
        // ============ تهيئة Firebase ============
        const firebaseConfig = {
            apiKey: "AIzaSyDZFR9qYKG3vbrrwhNIpy7N3Rfl4J5bxzA",
            authDomain: "marjan-88c6e.firebaseapp.com",
            projectId: "marjan-88c6e",
            storageBucket: "marjan-88c6e.firebasestorage.app",
            messagingSenderId: "92987465899",
            appId: "1:92987465899:web:f91398c67f4812b67e57ee",
            measurementId: "G-FX97RGZRPT"
        };

        // تهيئة Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        // ------------------ إضافة هذا ------------------
        function updateNavBadge(type, notifications) {
            const id = type === 'notifications' ? 'notificationsBadge' : null;
            if (!id) return;

            const badge = document.getElementById(id);
            if (!badge) return;

            // حساب الإشعارات الغير مقروءة فقط
            const unreadCount = notifications.filter(notification => !notification.read).length;

            if (unreadCount > 0) {
                badge.textContent = unreadCount > 99 ? '99+' : String(unreadCount);
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }
        // ------------------ نهاية الإضافة ------------------


        // ============ إدارة الإشعارات ============
        // عناصر DOM
        const notificationsList = document.getElementById('notificationsList');
        const emptyState = document.getElementById('emptyState');

        // UID المستخدم الحالي (سيتم الحصول عليه من localStorage)
        let currentUserUID = null;

        // ============ تحميل الإشعارات عند فتح الصفحة ============
        document.addEventListener('DOMContentLoaded', function() {
            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    loadUserNotifications();
                    listenToGlobalChat();
                } else {
                    console.log('لم يتم تسجيل الدخول');
                    showEmptyState();
                }
            });
        });

        // ============ تحميل إشعارات المستخدم ============
        // ============ تحميل إشعارات المستخدم ============
        // ============ تحميل إشعارات المستخدم ============
        // تصحيح UID من بيانات المستخدم الفعلية
        function correctUserUID() {
            const storedUID = localStorage.getItem('userUID');
            console.log('UID في localStorage:', storedUID);
            
            // البحث عن المستخدم الحقيقي بالبريد الإلكتروني أو أي بيانات أخرى
            const userEmail = localStorage.getItem('userEmail'); // إذا كان مخزناً
            
            if (userEmail) {
                db.collection('users')
                    .where('email', '==', userEmail)
                    .get()
                    .then(snapshot => {
                        if (!snapshot.empty) {
                            snapshot.forEach(doc => {
                                const correctUID = doc.data().uid;
                                console.log('الUID الصحيح:', correctUID);
                                
                                // تحديث localStorage بالUID الصحيح
                                localStorage.setItem('userUID', correctUID);
                                currentUserUID = correctUID;
                                
                                // إعادة تحميل الإشعارات
                                loadUserNotifications();
                            });
                        }
                    });
            }
        }
        

        // في DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function() {
            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    loadUserNotifications();
                    listenToGlobalChat();
                } else {
                    console.log('لم يتم تسجيل الدخول');
                    showEmptyState();
                }
            });
        });
        // ============ تحميل إشعارات المستخدم ============
        function loadUserNotifications() {
            const user = firebase.auth().currentUser;
            
            if (!user) {
                console.log('لا يوجد مستخدم مسجل دخول');
                showEmptyState();
                return;
            }

            console.log('جاري البحث عن المستخدم باستخدام البريد:', user.email);

            // البحث عن المستخدم باستخدام البريد الإلكتروني
            db.collection('users')
                .where('email', '==', user.email)
                .limit(1)
                .get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        console.log('لم يتم العثور على مستخدم بهذا البريد');
                        showEmptyState();
                        return;
                    }

                    // هناك مستخدم واحد فقط لكل بريد
                    const doc = snapshot.docs[0];
                    const userData = doc.data();
                    const notifications = userData.notifications || [];

                    if (notifications.length === 0) {
                        console.log('لا توجد إشعارات للمستخدم');
                        showEmptyState();
                        return;
                    }

                    console.log('تم تحميل عدد الإشعارات:', notifications.length);
                    displayNotifications(notifications);
                })
                .catch(error => {
                    console.error('خطأ في تحميل الإشعارات:', error);
                    showEmptyState();
                });
        }
        
        // دالة للتحقق من هيكل قاعدة البيانات
        function checkDatabaseStructure() {
            db.collection('users').limit(5).get()
                .then(snapshot => {
                    console.log('المستخدمون الموجودون في قاعدة البيانات:');
                    snapshot.forEach(doc => {
                        console.log('مستند:', doc.id, 'بيانات:', doc.data());
                    });
                })
                .catch(error => {
                    console.error('خطأ في التحقق من قاعدة البيانات:', error);
                });
        }

        // استدعاء الدالة للتحقق
        checkDatabaseStructure();

        // عرض حالة عدم وجود إشعارات
        function showEmptyState() {
            emptyState.style.display = 'block';
            notificationsList.innerHTML = '';
            notificationsList.appendChild(emptyState);
        }
        // العناصر الجديدة
        const backdrop = document.getElementById('notif-backdrop');
        const titleEl = document.getElementById('notif-title');
        const messageEl = document.getElementById('notif-message');
        const imageEl = document.getElementById('notif-image');

        // فتح النافذة الجديدة
        // فتح النافذة الجديدة
        // فتح النافذة الجديدة
        // في دالة openModal
        // فتح النافذة الجديدة
        function openModal(notification) {
            // التعامل مع العنوان
            const subtitleEl = document.getElementById('notif-subtitle');
            if (notification.title) {
                subtitleEl.textContent = notification.title;
                subtitleEl.style.display = 'block';
            } else {
                subtitleEl.style.display = 'none';
            }
            
            // التعامل مع الرسالة
            const messageEl = document.getElementById('notif-message');
            if (notification.message.length > 200) {
                messageEl.textContent = notification.message.substring(0, 200) + "...";
            } else {
                messageEl.textContent = notification.message;
            }
            
            // التعامل مع المرفق (صورة أو فيديو)
            const imageEl = document.getElementById('notif-image');
            let videoElement = document.getElementById('notif-video');
            
            // إخفاء كلا العنصرين أولاً
            imageEl.style.display = 'none';
            if (videoElement) {
                videoElement.style.display = 'none';
            }
            
            if (notification.attachment) {
                if (notification.attachment.type.startsWith('image/') || notification.attachment.type === 'image') {
                    // عرض صورة فقط
                    imageEl.src = notification.attachment.url;
                    imageEl.style.display = 'block';
                    imageEl.alt = 'صورة الإشعار';
                    console.log('✅ تم تحميل الصورة:', notification.attachment.url);
                } else if (notification.attachment.type.startsWith('video/') || notification.attachment.type === 'video') {
                    // عرض فيديو فقط
                    // إنشاء عنصر فيديو ديناميكي إذا لم يكن موجوداً
                    if (!videoElement) {
                        videoElement = document.createElement('video');
                        videoElement.id = 'notif-video';
                        videoElement.controls = true;
                        videoElement.style.width = '100%';
                        videoElement.style.maxHeight = '200px';
                        videoElement.style.objectFit = 'cover';
                        videoElement.style.borderRadius = '8px';
                        videoElement.style.marginBottom = '15px';
                        videoElement.style.display = 'none';
                        imageEl.parentNode.insertBefore(videoElement, imageEl.nextSibling);
                    }
                    
                    videoElement.innerHTML = `
                        <source src="${notification.attachment.url}" type="${notification.attachment.type}">
                        متصفحك لا يدعم تشغيل الفيديو
                    `;
                    videoElement.style.display = 'block';
                    console.log('✅ تم تحميل الفيديو:', notification.attachment.url);
                }
            }
            
            // التعامل مع الرابط
            const buttonContainer = document.getElementById('button-container');
            const buttonEl = document.getElementById('notif-button');
            
            if (notification.url) {
                buttonContainer.style.display = 'block';
                buttonEl.setAttribute('data-url', notification.url);
            } else {
                buttonContainer.style.display = 'none';
            }
            
            backdrop.style.display = 'flex';
        }
        function openNotificationUrl() {
            const buttonEl = document.getElementById('notif-button');
            const url = buttonEl.getAttribute('data-url');
            if (url) {
                window.open(url, '_blank');
                closeModal(); // إغلاق النافذة بعد فتح الرابط
            }
        }

        function closeModal() {
            backdrop.style.display = 'none';
        }

        // إغلاق النافذة عند النقر خارج المحتوى
        backdrop.addEventListener('click', function(e) {
            if (e.target === backdrop) {
                closeModal();
            }
        });

        // عرض الإشعارات
        function displayNotifications(notifications) {
            emptyState.style.display = 'none';
            notificationsList.innerHTML = '';

            notifications.sort((a, b) => {
                const timeA = a.timestamp?.toDate ? a.timestamp.toDate() : new Date(a.timestamp);
                const timeB = b.timestamp?.toDate ? b.timestamp.toDate() : new Date(b.timestamp);
                return timeB - timeA;
            });

            notifications.forEach((notification, index) => {
                const notificationElement = createNotificationElement(notification, index);
                notificationsList.appendChild(notificationElement);
            });

            updateRelativeTimes();

            // ✅ التعديل هنا: إرسال مصفوفة الإشعارات كاملة بدلاً من الطول فقط
            updateNavBadge('notifications', notifications);
        }


        // إنشاء عنصر إشعار
        // إنشاء عنصر إشعار
        function createNotificationElement(notification, index) {
            const notificationItem = document.createElement('div');
            notificationItem.className = 'notification-item';
            
            // تحديد نوع الإشعار
            let notificationType = 'admin';
            
            notificationItem.setAttribute('data-type', notificationType);
            notificationItem.setAttribute('data-id', notification.id);
            
            // تحويل الطابع الزمني إلى تاريخ
            const timestamp = notification.timestamp?.toDate ? 
                notification.timestamp.toDate() : new Date(notification.timestamp);
            
            const relativeTime = getRelativeTime(timestamp);
            
           

            // التحقق من وجود صورة أو فيديو مرفق
            const hasImage = notification.attachment && 
                            (notification.attachment.type.startsWith('image/') || 
                            notification.attachment.type === 'image') &&
                            notification.attachment.url;

            const hasVideo = notification.attachment && 
                            (notification.attachment.type.startsWith('video/') || 
                            notification.attachment.type === 'video') &&
                            notification.attachment.url;

            notificationItem.innerHTML = `
                <div class="notification-icon">
                    ${hasImage ? 
                        `<img src="${notification.attachment.url}" alt="صورة الإشعار">` :
                        hasVideo ? 
                        `<div class="video-thumbnail-container">
                            <div class="video-icon-fallback">
                                <i class="fas fa-video"></i>
                            </div>
                            <div class="video-play-icon">
                                <i class="fas fa-play"></i>
                            </div>
                        </div>` :
                        `<i class="fas fa-bell"></i>`
                    }
                </div>
                <div class="notification-content">
                    ${notification.title ? `<div class="notification-title">${notification.title}</div>` : ''}
                    <div class="notification-text">${notification.message}</div>
                    <div class="notification-time">
                        <span class="relative-time" data-timestamp="${timestamp.toISOString()}">${relativeTime}</span>
                    </div>
                </div>
                <button class="notification-delete" onclick="deleteNotification('${notification.id}')">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            // إضافة حدث النقر لفتح النافذة المنبثقة
            notificationItem.style.cursor = 'pointer';
            notificationItem.addEventListener('click', function(e) {
                if (!e.target.closest('.notification-delete')) {
                    openModal(notification);
                }
            });
            
            // جعل الإشعار غير مقروء إذا كان جديداً
            if (!notification.read) {
                notificationItem.classList.add('unread');
                
                notificationItem.addEventListener('click', function(e) {
                    if (!e.target.closest('.notification-delete')) {
                        markNotificationAsRead(notification.id);
                        notificationItem.classList.remove('unread');
                    }
                });
            }
            
            return notificationItem;
        }
        // إنشاء معاينة للمرفق
        function createAttachmentPreview(attachment) {
            const previewDiv = document.createElement('div');
            previewDiv.style.marginTop = '10px';
            
            if (attachment.type.startsWith('image/')) {
                previewDiv.innerHTML = `
                    <img src="${attachment.url}" alt="مرفق الصورة" 
                         style="max-width: 100px; max-height: 100px; border-radius: 5px; cursor: pointer;"
                         onclick="openAttachment('${attachment.url}')">
                `;
            } else if (attachment.type.startsWith('video/')) {
                previewDiv.innerHTML = `
                    <video controls style="max-width: 200px; max-height: 150px; border-radius: 5px;">
                        <source src="${attachment.url}" type="${attachment.type}">
                        متصفحك لا يدعم تشغيل الفيديو
                    </video>
                `;
            }
            
            return previewDiv;
        }

        // إنشاء رابط للإشعار
        function createUrlLink(url) {
            const linkDiv = document.createElement('div');
            linkDiv.style.marginTop = '5px';
            linkDiv.innerHTML = `
                <a href="${url}" target="_blank" 
                   style="color: #1a2a6c; text-decoration: none; font-size: 0.8rem;">
                   <i class="fas fa-external-link-alt"></i> فتح الرابط
                </a>
            `;
            return linkDiv;
        }

        // فتح المرفق في نافذة جديدة
        function openAttachment(url) {
            window.open(url, '_blank');
        }

        // الحصول على الوقت النسبي
        function getRelativeTime(timestamp) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - timestamp) / 1000);
            
            if (diffInSeconds < 60) {
                return 'الآن';
            } else if (diffInSeconds < 3600) {
                const minutes = Math.floor(diffInSeconds / 60);
                return `منذ ${minutes} دقيقة`;
            } else if (diffInSeconds < 86400) {
                const hours = Math.floor(diffInSeconds / 3600);
                return `منذ ${hours} ساعة`;
            } else if (diffInSeconds < 604800) {
                const days = Math.floor(diffInSeconds / 86400);
                return `منذ ${days} يوم`;
            } else {
                return timestamp.toLocaleDateString('ar-SA');
            }
        }

        // تحديث الأوقات النسبية
        function updateRelativeTimes() {
            const timeElements = document.querySelectorAll('.relative-time');
            const now = new Date();
            
            timeElements.forEach(element => {
                const timestamp = new Date(element.getAttribute('data-timestamp'));
                const relativeTime = getRelativeTime(timestamp);
                element.textContent = relativeTime;
            });
        }

        // تحديد الإشعار كمقروء
        // تحديد الإشعار كمقروء
        // تحديد الإشعار كمقروء
        function markNotificationAsRead(notificationId) {
            const user = firebase.auth().currentUser;
            if (!user) return;

            db.collection('users')
                .where('email', '==', user.email)
                .limit(1)
                .get()
                .then(snapshot => {
                    if (snapshot.empty) return;

                    const doc = snapshot.docs[0];
                    const userRef = db.collection('users').doc(doc.id);
                    const notifications = doc.data().notifications || [];

                    const index = notifications.findIndex(n => n.id === notificationId);
                    if (index !== -1) {
                        notifications[index].read = true;

                        userRef.update({ notifications })
                            .then(() => console.log('تم تحديث حالة الإشعار'))
                            .catch(error => console.error('خطأ في التحديث:', error));
                        loadUserNotifications();
                    }
                })
                .catch(error => {
                    console.error('خطأ في تحديث حالة الإشعار:', error);
                });
        }


        // حذف الإشعار
        // حذف الإشعار
        // حذف الإشعار
        function deleteNotification(notificationId) {
            const user = firebase.auth().currentUser;
            if (!user) return;

            const notificationItem = document.querySelector(`[data-id="${notificationId}"]`);

            if (notificationItem) {
                notificationItem.style.transition = 'all 0.3s ease';
                notificationItem.style.opacity = '0';
                notificationItem.style.transform = 'translateX(100%)';

                setTimeout(() => {
                    db.collection('users')
                        .where('email', '==', user.email)
                        .limit(1)
                        .get()
                        .then(snapshot => {
                            if (snapshot.empty) return;

                            const doc = snapshot.docs[0];
                            const userRef = db.collection('users').doc(doc.id);
                            const notifications = doc.data().notifications || [];

                            const index = notifications.findIndex(n => n.id === notificationId);
                            if (index !== -1) {
                                notifications.splice(index, 1);
                                userRef.update({ notifications })
                                    .then(() => console.log('✅ تم حذف الإشعار'))
                                    .catch(error => console.error('❌ خطأ في الحذف:', error));
                            }
                        })
                        .catch(error => {
                            console.error('❌ خطأ في حذف الإشعار:', error);
                        });

                    notificationItem.remove();

                    if (document.querySelectorAll('.notification-item').length === 0) {
                        showEmptyState();
                    }
                }, 300);
            }
        }


        // تحديث الأوقات النسبية كل دقيقة
        setInterval(updateRelativeTimes, 60000);

        // ============ التنقل بين الصفحات ============
        document.getElementById('bottomNavCompetitions').addEventListener('click', function(e) {
            e.preventDefault();
            window.location.href = 'chat.html';
        });
        
        document.getElementById('bottomNavAdd').addEventListener('click', function(e) {
            e.preventDefault();
            window.location.href = 'Add.html';
        });
        
        document.getElementById('bottomNavAccount').addEventListener('click', function(e) {
            e.preventDefault();
            window.location.href = 'Account.html';
        });
        // ============ نظام مراقبة الرسائل الجديدة ============
        let globalMessages = [];

        function listenToGlobalChat() {
            db.collection('global_chat')
                .orderBy('timestamp', 'desc')
                .onSnapshot(snapshot => {
                    globalMessages = [];
                    snapshot.forEach(doc => {
                        globalMessages.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    updateChatBadge();
                });
        }

        function updateChatBadge() {
            const readMessages = JSON.parse(localStorage.getItem('readMessages')) || [];
            const unreadCount = globalMessages.filter(msg => 
                msg.type === 'admin_message' && !readMessages.includes(msg.id)
            ).length;
            
            const badge = document.getElementById('chatBadge');
            if (badge) {
                if (unreadCount > 0) {
                    badge.textContent = unreadCount > 99 ? '99+' : String(unreadCount);
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }
        }
        firebase.auth().onAuthStateChanged(async (user) => {
            if (user) {
                console.log("✅ المستخدم مسجل الدخول:", user.email);

                // جلب الرسائل غير المقروءة للمسابقات والدردشة
                await updateCompetitionsBadge();
            }
        });

        // ✅ دالة مخصصة لتحديث الشارة في الصفحة الرئيسية
        async function updateCompetitionsBadge() {
            const badge = document.getElementById('chatBadge');
            if (!badge) return;

            const user = firebase.auth().currentUser;
            if (!user) {
                badge.classList.add('hidden');
                return;
            }

            try {
                const readMessages = JSON.parse(localStorage.getItem('readMessages')) || [];
                let unreadCount = 0;

                // 🏆 جلب المسابقات غير المقروءة
                const competitionsSnapshot = await db.collection('permanent_competitions').get();
                competitionsSnapshot.forEach(doc => {
                    if (!readMessages.includes(doc.id)) unreadCount++;
                });

                // 💬 جلب رسائل المستخدم الخاصة
                const userSnapshot = await db.collection('users')
                    .where('email', '==', user.email)
                    .limit(1)
                    .get();

                if (!userSnapshot.empty) {
                    const userData = userSnapshot.docs[0].data();
                    const chatMessages = userData.chatMessages || [];

                    chatMessages.forEach(msg => {
                        if (msg.type === 'admin_message' && !readMessages.includes(msg.id)) unreadCount++;
                    });
                }

                // ✅ تحديث الشارة في الشريط السفلي
                if (unreadCount > 0) {
                    badge.textContent = unreadCount > 99 ? '99+' : String(unreadCount);
                    badge.classList.remove('hidden');
                    badge.style.display = 'flex';
                } else {
                    badge.classList.add('hidden');
                    badge.style.display = 'none';
                }

            } catch (error) {
                console.error("❌ خطأ في تحديث شارة المسابقات:", error);
            }
        }

        // تفاعل الشريط السفلي
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
                document.querySelectorAll('.nav-item').forEach(navItem => {
                    navItem.classList.remove('active');
                });
                this.classList.add('active');
            });
        });
        

       
    </script>
</body>

</html>

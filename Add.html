<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مرجان - أضف إعلان جديد</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- CSS الخاص بـ Video.js -->
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <!-- JavaScript الخاص بـ Video.js -->
    <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
    <!-- إضافة مكتبات Firebase هنا -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <!-- إضافة Firebase SDK المطلوب -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        /* ============ الإعدادات العامة والهيكل الأساسي ============ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Tajawal', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            padding-bottom: 50px; /* إضافة حشوة سفلية للشريط */
        }
        
        .container {
            width: 100%;
            max-width: 100%;
            margin: 0;
            padding: 0;
            flex: 1;
            display: flex;
        }
        
        /* ============ نموذج الإعلان ============ */
        .ad-form {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            margin: 15px;
            border-radius: 0px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            flex: 1;
            min-height: calc(100vh - 30px);
            display: flex;
            flex-direction: column;
        }
        
        .form-title {
            text-align: center;
            margin-bottom: 30px;
            color: #1a2a6c;
            font-size: 1.8rem;
            position: relative;
            padding-bottom: 15px;
        }
        
        .form-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 150px;
            height: 4px;
            background: linear-gradient(to right, #ff8c00, #ff4500);
            border-radius: 2px;
        }
        
                
        .form-group {
            margin-bottom: 25px;
            display: block;
        }
        
        .form-group.hidden {
            display: none;
        }
        
        .form-label {
            display: block;
            margin-bottom: 12px;
            font-weight: bold;
            color: #1a2a6c;
            font-size: 1.1rem;
        }
        /* إضافة هذا النمط في قسم الأنماط */
        /* إضافة هذا النمط في قسم الأنماط */
        .form-input::placeholder,
        .form-textarea::placeholder,
        .phone-input::placeholder {
        font-size: 1.1em;
        color: #666;
        }

        /* تكبير حجم النص في الحقول المهمة بشكل خاص */
        #adTitle::placeholder {
        font-size: 1.2em;
        }

        #cityInput::placeholder {
        font-size: 1.2em;
        }

        #adDescription::placeholder {
        font-size: 1.2em;
        }

        #phoneNumber::placeholder {
        font-size: 1.2em;
        }
        
        
        .form-input, .form-select {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s;
            background: white;
        }
        
        .form-input:focus, .form-select:focus {
            border-color: #4a6fc5;
            box-shadow: 0 0 0 3px rgba(74, 111, 197, 0.2);
        }
        
        .form-select {
            cursor: pointer;
        }
        
        /* ============ نافذة اختيار الغرض ============ */
        .purpose-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .purpose-popup.active {
            opacity: 1;
            visibility: visible;
        }
        
        .purpose-content {
            background: white;
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            overflow-y: auto;
            border-radius: 20px;
            padding: 25px;
            position: relative;
            min-height: 200px;
            display: flex;
            flex-direction: column;

        }
        
        .close-popup {
            position: absolute;
            top: 20px;
            left: 20px;
            background: none;
            border: none;
            font-size: 1.8rem;
            color: #1a2a6c;
            cursor: pointer;
        }
        
        .purpose-title {
            text-align: center;
            margin: 15px 0 30px;
            color: #1a2a6c;
            font-size: 1.6rem;
        }
        
        .purpose-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            color: #1a2a6c;
            font-size: 1.3rem;
            direction: rtl;
        }
        
        .section-header i {
            margin-left: 15px;
            font-size: 1.5rem;
            margin-right: 10px;
        }
        
        .purpose-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            overflow-y: auto;
            flex: 1; /* لملء المساحة المتاحة */
        }
        
        .purpose-option {
            padding: 15px;
            border: 2px solid #e6e9ef;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f9f9f9;
            font-size: 1rem;
        }
        
        .purpose-option:hover {
            border-color: #4a6fc5;
            background: #f0f5ff;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        /* ============ تحميل الصور والفيديوهات ============ */
        .image-upload {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        
        @media (min-width: 576px) {
            .image-upload {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        .upload-box {
            height: 120px;
            border: 2px dashed #ddd;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: border-color 0.3s;
            background: #f9f9f9;
        }
        
        .upload-box:hover {
            border-color: #4a6fc5;
            background: #f0f5ff;
        }
        
        .upload-box i {
            font-size: 2rem;
            color: #4a6fc5;
            margin-bottom: 10px;
        }
        
        .upload-box span {
            color: #666;
            font-size: 0.9rem;
        }
        
        /* معاينة الصور والفيديوهات */
        .image-previews {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .image-preview {
            height: 100px;
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            background-color: #f0f0f0; /* إضافة خلفية شفافة */
            border-radius: 8px;
            position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
             border: 1px solid #ddd; /* إضافة حدود خفيفة */
        }
        
        .video-preview {
            height: 100px;
            background-color: #f0f0f0;
            border-radius: 8px;
            position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .video-preview video {
            max-width: 100%;
            max-height: 100%;
            border-radius: 8px;
        }
        
        .remove-image {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255,0,0,0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        /* ============ حقل النص ============ */
        .form-textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            outline: none;
            resize: vertical;
            min-height: 150px;
            transition: border-color 0.3s;
        }
        
        .form-textarea:focus {
            border-color: #4a6fc5;
            box-shadow: 0 0 0 3px rgba(74, 111, 197, 0.2);
        }
        
        /* ============ حقل الهاتف ============ */
        .phone-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s;
        }
        
        .phone-input:focus {
            border-color: #4a6fc5;
            box-shadow: 0 0 0 3px rgba(74, 111, 197, 0.2);
        }
        
        /* ============ أزرار الإجراء ============ */
        .form-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 30px;
        }
        
        @media (min-width: 576px) {
            .form-buttons {
                flex-direction: row;
                justify-content: space-between;
            }
        }
        
        .save-btn, .publish-btn {
            padding: 15px 25px;
            border: none;
            border-radius: 30px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            flex: 1;
        }
        
        .save-btn {
            background: #e6e9ef;
            color: #4a6fc5;
        }
        
        .save-btn:hover {
            background: #d0d5e0;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .publish-btn {
            background: linear-gradient(to right, #1a2a6c, #4a6fc5);
            color: white;
            box-shadow: 0 4px 15px rgba(26, 42, 108, 0.3);
        }
        
        .publish-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(26, 42, 108, 0.4);
        }
        
        /* ============ رسالة النجاح ============ */
        .success-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 128, 0, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .success-message.active {
            opacity: 1;
            visibility: visible;
        }
        
        /* ============ رسالة الانتظار ============ */
        .waiting-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 165, 0, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .waiting-message.active {
            opacity: 1;
            visibility: visible;
        }
        
        /* ============ رسائل الخطأ ============ */
        .error-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 0, 0, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .error-message.active {
            opacity: 1;
            visibility: visible;
        }
        
        /* ============ الشريط السفلي الزجاجي المعدل ============ */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 25px 25px 0 0;
            padding: 15px 20px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -5px 25px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 999;
        }
        
        .nav-item {
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            font-size: 0.85rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 15px;
            border-radius: 50px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .nav-item i {
            margin-bottom: 4px;
            font-size: 1.2rem;
            position: relative;
            z-index: 2;
        }
        
        .nav-item span {
            position: relative;
            z-index: 2;
        }
        
        .nav-item.active {
            color: #1a2a6c;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.6);
            border-radius: 50px;
            padding: 5px 20px;
        }
        
        .nav-item:not(.active):hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        .nav-badge {
            position: absolute;
            top: 2px;
            right: 20px;
            background: linear-gradient(45deg, #ff4757, #ff3838);
            color: white;
            border-radius: 50%;
            width: 15px;
            height: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.5rem;
            font-weight: bold;
            box-shadow: 0 2px 6px rgba(255, 71, 87, 0.5);
            z-index: 3;
        }

        .nav-badge.hidden {
            display: none;
        }
        
        .nav-item::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
        }
        
        .nav-item:active::before {
            width: 300px;
            height: 300px;
        }
        
        .add-center {
            background: linear-gradient(45deg, #ff8c00, #ff4500);
            color: white;
            padding: 12px 25px;
            border-radius: 50px;
            font-weight: bold;
            display: flex;
            align-items: center;
            box-shadow: 0 4px 15px rgba(255, 140, 0, 0.4);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .add-center::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
        }
        
        .add-center:active::before {
            width: 300px;
            height: 300px;
        }
        
        .add-center:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(255, 140, 0, 0.5);
        }
        
        /* ============ التصميم المتجاوب ============ */
        @media (max-width: 768px) {
  
            .form-group {
                margin-bottom: 13px; /* تقليل من 25px إلى 18px */
            }

            .form-label {
                font-size: 0.9rem;
            }
            .form-input, .form-select, .form-textarea, .phone-input {
                font-size: 0.85rem;
                padding: 11px;
            }
            .purpose-option {
                font-size: 0.9rem;
                padding: 12px;
            }
            .upload-box span {
                font-size: 0.8rem;
            }
            .save-btn, .publish-btn {
                font-size: 1rem;
                padding: 12px 20px;
            }
            .form-input::placeholder,
            .form-textarea::placeholder,
            .phone-input::placeholder {
               font-size: 0.85em;
            }
            .purpose-content {
                font-size: 0.9rem;
                width: 80%;
                max-height: 590vh;
                padding: 20px;
            }
            .purpose-title {
                font-size: 1.25rem;
            }

            .ad-form {
                padding: 20px;
                margin: 10px;
            }
            
            .form-title {
                font-size: 1.5rem;
            }
            
            .purpose-options {
                grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
                gap: 12px;

            }
            
            .image-previews {
                grid-template-columns: repeat(2, 1fr);
            }
            
            /* تعديلات للشريط السفلي على الشاشات المتوسطة */
            .bottom-nav {
                padding: 10px 15px;
                border-radius: 20px 20px 0 0;
            }
            
            .nav-item {
                padding: 8px 10px;
                font-size: 0.7rem;
            }
            
            .nav-item i {
                font-size: 1.1rem;
            }
            
            .add-center {
                padding: 8px 16px;
                font-size: 0.8rem;
            }
        }
        
        @media (max-width: 480px) {
            #bottomNavCompetitions .nav-badge {
                top: 0.7
                px;
                right: 10px;
                width: 12.5px;
                height: 12.5px;
                font-size: 0.5rem;
            }
            
            #notificationsBadge {
                top: 0.7
                px;
                right: 14px;
                width: 12.5px;
                height: 12.5px;
                font-size: 0.5rem;
            }
            .nav-badge {
                top: 6px;
                right: 12px;
                width: 13px;
                height: 13px;
                font-size: 0.5rem;
                top: 1px;
                right: 20px;
            }
            
            
            .form-input::placeholder,
            .form-textarea::placeholder,
            .phone-input::placeholder {
            font-size: 0.1rem;
            }
            #adTitle::placeholder,
            #cityInput::placeholder,
            #adDescription::placeholder,
            #phoneNumber::placeholder {
                font-size: 0.93rem;
            }
            /* معاينة الفيديو */
            .video-preview {
                width: 200px;   /* أو أي حجم يناسبك */
                height: 150px;
                position: relative;
                margin: 5px;
                border: 1px solid #ddd;
                border-radius: 8px;
                overflow: hidden;
                background: #000; /* عشان يكون في خلفية واضحة */
            }
            .video-preview video {
                width: 100%;
                height: 100%;
                object-fit: contain; /* أو contain لو عايز كامل الفيديو يظهر */
                display: block;
            }
            .waiting-message {
                font-size: 11px; /* تقليل حجم الخط */
                padding: 10px 20px; /* تقليل الحشو */
            }
            .success-message {
                padding: 10px 10px; /* تقليل الحشو */
                font-size: 13px; /* إضافة حجم خط أصغر */
            }
            .error-message {
                padding: 8px 15px;
                font-size: 13px;
                max-width: 90%;
                left: 50%;
                transform: translateX(-50%);
            }
            
            .error-message i {
                font-size: 1.1rem;
            }
            .image-previews {
                grid-template-columns: 1fr;
            }
            .image-preview {
                height: 120px; /* زيادة الارتفاع قليلاً للشاشات الصغيرة */
            }
            .form-group {
                 margin-bottom: 11px; /* تقليل أكثر للشاشات الصغيرة */
            }
            
            
            
            .form-label {
                font-size: 0.85rem;
                margin-bottom: 5px;
            }
            .form-select, .form-textarea {
                font-size: 0.8rem;
                padding: 8px 10px !important;
            }
            .form-input::placeholder,
            .form-textarea::placeholder,
            .phone-input::placeholder {
                font-size: 0.8rem !important;
            }
            .purpose-option {
                font-size: 0.85rem;
                padding: 12px;

            }
            .upload-box {
                height: 80px;
            }
            .upload-box i {
                font-size: 0.8rem !important; /* تصغير حجم الأيقونات */
                margin-bottom: 5px !important;
            }
            .form-group:has(#adDescription) {
                margin-top: -19px !important;
            }
            .form-group:has(#imageUploadContainer) .form-label {
                margin-bottom: 10px !important;
            }
            .upload-box span {
                font-size: 0.7rem;
            }
            .save-btn, .publish-btn {
                flex: 1 !important; /* يتقاسمان المساحة بالتساوي */
                min-width: 120px !important; /* عرض أدنى */
                padding: 12px 1px !important;
                font-size: 0.8rem !important;
            }
            .salary-range span, .experience-input span {
                font-size: 0.8rem;
            }
            .checkbox-label span {
                font-size: 0.85rem;
            }
            /* تحسين إضافي للنصوص في جميع الأحجام */
            .form-input::placeholder,
            .form-textarea::placeholder,
            .phone-input::placeholder {
               font-size: 1.1em;
 
            }
            .purpose-content {
              font-size: 0.85rem;
              width: 80%;
              max-height: 50vh;
              padding: 15px;
              border-radius: 15px;
            }
           .purpose-title {
             font-size: 1.1rem;
            }

            .ad-form {
                padding: 12px;
                margin: 0px;
            }
            
            .form-title {
                font-size: 1rem !important;
                margin-bottom: 20px !important;
                padding-bottom: 7px !important;
            }
            .form-title::after {
                width: 130px !important; /* تقليل طول الخط */
                height: 3px !important; /* تقليل سمك الخط قليلاً */
            }
            

            
            .purpose-options {
                grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
                gap: 10px;

            }
            
            .image-upload {
                grid-template-columns: repeat(2, 1fr) !important; /* صف واحد بخانتين */
                gap: 10px !important;
            }
            
            .image-previews {
                grid-template-columns: 1fr;
            }
            
            .form-buttons {
                flex-direction: row !important; /* يبقى في صف واحد */
                justify-content: space-between !important;
                gap: 10px !important;
            }
            
            /* تعديلات للشريط السفلي على الشاشات الصغيرة */
            .bottom-nav {
                padding: 3px 0px;
            }
            
            .nav-item {
                padding: 5px 8px;
                font-size: 0.6rem;
            }
            
            .nav-item i {
                font-size: 1rem;
            }
            
            .add-center {
                padding: 6px 12px;
                font-size: 0.7rem;
            }
        }

        @media (max-width: 350px) {
            .bottom-nav {
                padding: 5px 8px;
            }
            
            .nav-item {
                padding: 4px 6px;
                font-size: 0.5rem;
            }
            
            .nav-item i {
                font-size: 0.9rem;
            }
            
            .add-center {
                padding: 5px 10px;
                font-size: 0.6rem;
            }
        }

        /* ============ حقول إضافية للوظائف ============ */
        .salary-range, .experience-input {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .salary-range input, .experience-input input {
            flex: 1;
        }
        
        .salary-range span, .experience-input span {
            color: #666;
            white-space: nowrap;
        }
        
        /* ============ حقول إضافية للعقارات ============ */
        .realestate-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        @media (max-width: 768px) {
            .realestate-fields {
                grid-template-columns: 1fr;
            }
        }

        /* ============ حقول إضافية للخدمات ============ */
        .services-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        
        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        
        @media (max-width: 768px) {
            .services-fields {
                grid-template-columns: 1fr;
            }
        }
    </style>
    
</head>
<body>
    <!-- رسالة النجاح -->
    <div class="success-message" id="successMessage">
        <i class="fas fa-check-circle"></i>
        <span>تم نشر الإعلان بنجاح!</span>
    </div>

    <!-- رسالة الانتظار -->
    <div class="waiting-message" id="waitingMessage">
        <i class="fas fa-spinner fa-spin"></i>
        <span>الرجاء الانتظار حتى يتم نشر إعلانك...</span>
    </div>

    <!-- رسالة الخطأ -->
    <div class="error-message" id="errorMessage">
        <i class="fas fa-exclamation-circle"></i>
        <span id="errorText"></span>
    </div>

    <!-- نموذج الإعلان -->
    <div class="container">
        <div class="ad-form">
            <h2 class="form-title" id="formMainTitle">أضف إعلان جديد</h2>
            
            <!-- اكتب عنوان الإعلان -->
            <div class="form-group">
                <label class="form-label">اكتب عنوان الإعلان</label>
                <input type="text" class="form-input" placeholder="اكتب عنوانًا جذابًا لإعلانك" id="adTitle">
            </div>
            
            <!-- حدد القسم المناسب -->
            <div class="form-group">
                <label class="form-label">حدد القسم المناسب لإعلانك</label>
                <div class="form-select" id="categorySelect">
                    اختر القسم المناسب
                </div>
            </div>
            
            <!-- نوع الإعلان (يظهر فقط عند اختيار قسم الوظائف) -->
            <div class="form-group hidden" id="jobTypeGroup">
                <label class="form-label">نوع الإعلان</label>
                <div class="form-select" id="jobTypeSelect">
                    اختر نوع الإعلان
                </div>
            </div>
            
            <!-- المجال المهني (يظهر فقط عند اختيار نوع الإعلان) -->
            <div class="form-group hidden" id="jobFieldGroup">
                <label class="form-label">المجال المهني</label>
                <div class="form-select" id="jobFieldSelect">
                    اختر المجال المهني
                </div>
            </div>
            
            <!-- نطاق الراتب (يظهر فقط عند اختيار نوع الإعلان المناسب) -->
            <div class="form-group hidden" id="salaryGroup">
                <label class="form-label">نطاق الراتب (ريال سعودي)</label>
                <div class="salary-range">
                    <input type="number" class="form-input" placeholder="من" id="minSalary">
                    <span>إلى</span>
                    <input type="number" class="form-input" placeholder="إلى" id="maxSalary">
                </div>
            </div>
            
            <!-- سنوات الخبرة (يظهر فقط عند اختيار نوع الإعلان المناسب) -->
            <div class="form-group hidden" id="experienceGroup">
                <label class="form-label">سنوات الخبرة</label>
                <div class="experience-input">
                    <input type="number" class="form-input" placeholder="عدد السنوات" id="experienceYears" min="0">
                    <span>سنة</span>
                </div>
            </div>
            
            <!-- حدد الغرض من الإعلان -->
            <div class="form-group">
                <label class="form-label">حدد الغرض من الإعلان</label>
                <div class="form-select" id="purposeSelect">
                    اختر الغرض من الإعلان
                </div>
            </div>
            
            <!-- نوع العقار (يظهر فقط عند اختيار قسم العقارات) -->
            <div class="form-group hidden" id="propertyTypeGroup">
                <label class="form-label">نوع العقار</label>
                <div class="form-select" id="propertyTypeSelect">
                    اختر نوع العقار
                </div>
            </div>
            
            <!-- حقول العقارات (تظهر فقط عند اختيار قسم العقارات) -->
            <div class="form-group hidden" id="realestateGroup">
                <label class="form-label">تفاصيل العقار</label>
                <div class="realestate-fields">
                    <div>
                        <label class="form-label">عدد الغرف</label>
                        <input type="number" class="form-input" placeholder="عدد الغرف" id="roomsCount" min="0">
                    </div>
                    <div>
                        <label class="form-label">عدد الحمامات</label>
                        <input type="number" class="form-input" placeholder="عدد الحمامات" id="bathroomsCount" min="0">
                    </div>
                    <div>
                        <label class="form-label">المساحة (م²)</label>
                        <input type="number" class="form-input" placeholder="المساحة بالمتر المربع" id="propertyArea" min="0">
                    </div>
                    <div>
                        <label class="form-label">السعر </label>
                        <input type="number" class="form-input" placeholder="السعر" id="propertyPrice">
                    </div>
                </div>
            </div>
            
            <!-- حقل السعر (يظهر فقط عند اختيار قسم سيارات) -->
            <div class="form-group hidden" id="priceGroup">
                <label class="form-label">السعر </label>
                <input type="number" class="form-input" placeholder="أدخل السعر" id="carPrice">
            </div>
            
            <!-- حقول الخدمات (تظهر فقط عند اختيار قسم الخدمات) -->
            <div class="form-group hidden" id="servicesGroup">
                <label class="form-label">تفاصيل الخدمة</label>
                <div class="services-fields">
                    <div>
                        <label class="form-label">نطاق السعر </label>
                        <div class="salary-range">
                            <input type="number" class="form-input" placeholder="من" id="serviceMinPrice">
                            <span>إلى</span>
                            <input type="number" class="form-input" placeholder="إلى" id="serviceMaxPrice">
                        </div>
                    </div>
                    <div>
                        <label class="form-label">التقييم</label>
                        <div class="salary-range">
                            <input type="number" class="form-input" placeholder="من" id="minRating" min="1" max="5" step="0.1">
                            <span>إلى</span>
                            <input type="number" class="form-input" placeholder="إلى" id="maxRating" min="1" max="5" step="0.1">
                        </div>
                    </div>
                    <div>
                        <label class="form-label">وقت التسليم</label>
                        <select class="form-select" id="deliveryTime">
                            <option value="">اختر وقت التسليم</option>
                            <option value="أي وقت">أي وقت</option>
                            <option value="أقل من يوم">أقل من يوم</option>
                            <option value="أقل من 3 أيام">أقل من 3 أيام</option>
                            <option value="أقل من أسبوع">أقل من أسبوع</option>
                            <option value="أقل من أسبوعين">أقل من أسبوعين</option>
                            <option value="أقل من شهر">أقل من شهر</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">الخدمات الإضافية</label>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="extraServices" value="ضمان الجودة">
                                <span>ضمان الجودة</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="extraServices" value="دعم مستمر">
                                <span>دعم مستمر</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="extraServices" value="تعديلات مجانية">
                                <span>تعديلات مجانية</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="extraServices" value="تسليم سريع">
                                <span>تسليم سريع</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- حقل اختيار المجال (يظهر فقط عند اختيار قسم منوعات) -->
            <div class="form-group hidden" id="subCategoryGroup">
                <label class="form-label">حدد المجال الذي تبحث عنه</label>
                <div class="form-select" id="subCategorySelect">
                    اختر المجال
                </div>
            </div>

            <!-- حقل السعر (يظهر فقط عند اختيار قسم منوعات) -->
            <div class="form-group hidden" id="miscellaneousPriceGroup">
                <label class="form-label">السعر (جنيه سوداني)</label>
                <input type="number" class="form-input" placeholder="أدخل السعر" id="miscellaneousPrice">
            </div>
            
            <!-- أين تريد عرض الإعلان -->
            <div class="form-group">
                <label class="form-label">أين تريد عرض إعلانك</label>
                <div class="form-select" id="locationSelect">
                    حدد الدولة
                </div>
            </div>

            <!-- أين تريد عرض الإعلان -->
            <div class="form-group">
                <label class="form-label">حدد المدينة</label>
                <input type="text" class="form-input" placeholder="اكتب اسم المدينة" id="cityInput">
            </div>
            
            <!-- رفع الصور والفيديوهات -->
            <div class="form-group">
                <label class="form-label">رفع صور وفيديوهات للإعلان (4 كحد أقصى)</label>
                <div class="image-upload" id="imageUploadContainer">
                    <div class="upload-box" onclick="document.getElementById('imageInput').click()">
                        <i class="fas fa-plus"></i>
                        <span>إضافة صورة</span>
                    </div>
                    <div class="upload-box" onclick="document.getElementById('videoInput').click()">
                        <i class="fas fa-video"></i>
                        <span>إضافة فيديو</span>
                    </div>
                </div>
                <input type="file" id="imageInput" accept="image/*" multiple style="display: none;" onchange="handleImageSelection(event)">
                <input type="file" id="videoInput" accept="video/*" style="display: none;" onchange="handleVideoSelection(event)">
                
                <!-- معاينة الصور والفيديوهات -->
                <div id="mediaPreviewContainer" style="display: none;">
                    <div class="image-previews" id="mediaPreviews">
                        
                    </div>
                </div>
            </div>
            
            <!-- نص الإعلان -->
            <div class="form-group">
                <label class="form-label">نص الإعلان</label>
                <textarea class="form-textarea" placeholder="اكتب نص الإعلان هنا..." id="adDescription"></textarea>
            </div>
            
            
            <!-- رقم الهاتف -->
            <div class="form-group">
                <label class="form-label">رقم الهاتف</label>
                <input type="tel" class="phone-input" placeholder="أدخل رقم الهاتف" id="phoneNumber">
            </div>
            
            <!-- أزرار الحفظ والنشر -->
            <div class="form-buttons">
                <button class="save-btn" id="saveBtn">
                    <i class="fas fa-save"></i> حفظ دون نشر
                </button>
                <button class="publish-btn" id="publishBtn">
                    <i class="fas fa-share"></i> نشر الإعلان
                </button>
            </div>
        </div>
    </div>
    
    <!-- نافذة اختيار القسم -->
    <div class="purpose-popup" id="categoryPopup">
        <div class="purpose-content">
            <button class="close-popup" id="closeCategoryPopup">
                <i class="fas fa-times"></i>
            </button>
            <h2 class="purpose-title">حدد القسم المناسب</h2>
            
            <div class="purpose-options">
                <div class="purpose-option" data-value="وظائف">وظائف</div>
                <div class="purpose-option" data-value="عقارات">عقارات</div>
                <div class="purpose-option" data-value="سيارات">سيارات</div>
                <div class="purpose-option" data-value="خدمات">خدمات</div>
                <div class="purpose-option" data-value="منوعات">منوعات</div>
                <div class="purpose-option" data-value="تعارف">تعارف</div>
            </div>
        </div>
    </div>
    
    <!-- نافذة اختيار نوع الإعلان للوظائف -->
    <div class="purpose-popup" id="jobTypePopup">
        <div class="purpose-content">
            <button class="close-popup" id="closeJobTypePopup">
                <i class="fas fa-times"></i>
            </button>
            <h2 class="purpose-title">حدد نوع الإعلان</h2>
            
            <div class="purpose-options">
                <div class="purpose-option" data-value="إعلان عن وظيفة شاغرة">إعلان عن وظيفة شاغرة</div>
                <div class="purpose-option" data-value="ابحث عن عمل">ابحث عن عمل</div>
                <div class="purpose-option" data-value="عرض خدمة خاصة">عرض خدمة خاصة</div>
            </div>
        </div>
    </div>
    
    <!-- نافذة اختيار المجال المهني -->
    <div class="purpose-popup" id="jobFieldPopup">
        <div class="purpose-content">
            <button class="close-popup" id="closeJobFieldPopup">
                <i class="fas fa-times"></i>
            </button>
            <h2 class="purpose-title">حدد المجال المهني</h2>
            
            <div class="purpose-options">
                <div class="purpose-option" data-value="سائق">سائق</div>
                <div class="purpose-option" data-value="حرفيين">حرفيين</div>
                <div class="purpose-option" data-value="مهندس">مهندس</div>
                <div class="purpose-option" data-value="تعليم و تدريس">تعليم و تدريس</div>
                <div class="purpose-option" data-value="عمالة منزلية">عمالة منزلية</div>
                <div class="purpose-option" data-value="حسابات">حسابات</div>
                <div class="purpose-option" data-value="خدمة الزبائن">خدمة الزبائن</div>
                <div class="purpose-option" data-value="إدارة">إدارة</div>
                <div class="purpose-option" data-value="حضانة أطفال">حضانة أطفال</div>
                <div class="purpose-option" data-value="حراسة و أمن">حراسة و أمن</div>
                <div class="purpose-option" data-value="طب و تمريض">طب و تمريض</div>
                <div class="purpose-option" data-value="خياطين">خياطين</div>
                <div class="purpose-option" data-value="شراكة">شراكة</div>
                <div class="purpose-option" data-value="حدائق و مناظر طبيعية">حدائق و مناظر طبيعية</div>
                <div class="purpose-option" data-value="mونتاج و أخراج">مونتاج و أخراج</div>
                <div class="purpose-option" data-value="برمجة">برmجة</div>
                <div class="purpose-option" data-value="محررين">mحرrين</div>
                <div class="purpose-option" data-value="متفرقات">متفرقات</div>
                <div class="purpose-option" data-value="سياحة و مطاعm">سياحة و مطاعم</div>
                <div class="purpose-option" data-value="mبيعات و تسويق">مبيعات و تسويق</div>
                <div class="purpose-option" data-value="mقاولات">مقاولات</div>
                <div class="purpose-option" data-value="تزيين و تجميل">تزيين و تجmيل</div>
                <div class="purpose-option" data-value="تقني">تقni</div>
                <div class="purpose-option" data-value="عمال">عمال</div>
                <div class="purpose-option" data-value="عمال تنظيف">عمال تنظيف</div>
                <div class="purpose-option" data-value="تصميم">تصميم</div>
                <div class="purpose-option" data-value="سكرتارية">سكرتارية</div>
                <div class="purpose-option" data-value="طب و تمريض">طب و تمريض</div>
                <div class="purpose-option" data-value="موظفين">موظفين</div>
                <div class="purpose-option" data-value="تقنين تكييف و تبريد">تقنين تكييف و تبريد</div>
                <div class="purpose-option" data-value="لياقة بدنية">لياقة بدنية</div>
                <div class="purpose-option" data-value="علاقات عامة">علاقات عامة</div>
                <div class="purpose-option" data-value="كمpiوتر و شبكات">كمبيوتر و شبكات</div>
                <div class="purpose-option" data-value="ازياء">ازياء</div>
                <div class="purpose-option" data-value="سياحة و سفر">سياحة و سفر</div>
                <div class="purpose-option" data-value="mترجمين">مترجمين</div>
            </div>
        </div>
    </div>
    
    <!-- نافذة اختيار الغرض -->
    <div class="purpose-popup" id="purposePopup">
        <div class="purpose-content">
            <button class="close-popup" id="closePurposePopup">
                <i class="fas fa-times"></i>
            </button>
            <h2 class="purpose-title">حدد الغرض من الإعلان</h2>
            
            <div id="purposeOptionsContainer">
                <!-- سيتم ملء هذا القسم بناءً على القسم المختار -->
            </div>
        </div>
    </div>
    
    <!-- نافذة اختيار نوع العقار -->
    <div class="purpose-popup" id="propertyTypePopup">
        <div class="purpose-content">
            <button class="close-popup" id="closePropertyTypePopup">
                <i class="fas fa-times"></i>
            </button>
            <h2 class="purpose-title">حدد نوع العقار</h2>
            
            <div class="purpose-options">
                <div class="purpose-option" data-value="شقة">شقة</div>
                <div class="purpose-option" data-value="فيلa">فيلا</div>
                <div class="purpose-option" data-value="منزل">منزل</div>
                <div class="purpose-option" data-value="أرض">أرض</div>
                <div class="purpose-option" data-value="عمارة">عمارة</div>
                <div class="purpose-option" data-value="شاليه">شاليه</div>
                <div class="purpose-option" data-value="استوديو">استوديو</div>
                <div class="purpose-option" data-value="محل تجاري">محل تجاري</div>
                <div class="purpose-option" data-value="mكتب">مكتب</div>
                <div class="purpose-option" data-value="أخرى">أخرى</div>
            </div>
        </div>
    </div>
    
    <!-- نافذة اختيار الدولة -->
    <div class="purpose-popup" id="locationPopup">
        <div class="purpose-content">
            <button class="close-popup" id="closeLocationPopup">
                <i class="fas fa-times"></i>
            </button>
            <h2 class="purpose-title">حدد الدولة</h2>
            
            <div class="purpose-options">
                <div class="purpose-option" data-value="مصر">مصر</div>
                <div class="purpose-option" data-value="السعودية">السعودية</div>
                <div class="purpose-option" data-value="الإمارات">الإمارات</div>
                <div class="purpose-option" data-value="الجزائر">الجزائر</div>
                <div class="purpose-option" data-value="السودان">السودان</div>
                <div class="purpose-option" data-value="العراق">العراق</div>
                <div class="purpose-option" data-value="المغرب">المغرب</div>
                <div class="purpose-option" data-value="اليمن">اليمن</div>
                <div class="purpose-option" data-value="سوريا">سوريا</div>
                <div class="purpose-option" data-value="تونس">تونس</div>
                <div class="purpose-option" data-value="الأردن">الأردن</div>
                <div class="purpose-option" data-value="فلسطين">فلسطين</div>
                <div class="purpose-option" data-value="لبنان">لبنان</div>
                <div class="purpose-option" data-value="عُمان">عُمان</div>
                <div class="purpose-option" data-value="قطر">قطر</div>
                <div class="purpose-option" data-value="الكويت">الكويت</div>
                <div class="purpose-option" data-value="البحرين">البحرين</div>
                <div class="purpose-option" data-value="موريتانيا">موريتانيا</div>
                <div class="purpose-option" data-value="جيبوتي">جيبوتي</div>
                <div class="purpose-option" data-value="جزر القمر">جزر القمر</div>
                <div class="purpose-option" data-value="ليبيا">ليبيا</div>
                <div class="purpose-option" data-value="الصومال">الصومال</div>
            </div>
        </div>
    </div>

    <!-- نافذة اختيار المجال للمنوعات -->
    <div class="purpose-popup" id="subCategoryPopup">
        <div class="purpose-content">
            <button class="close-popup" id="closeSubCategoryPopup">
                <i class="fas fa-times"></i>
            </button>
            <h2 class="purpose-title">حدد المجال</h2>
            <div class="purpose-options" id="subCategoryOptions">
                <!-- سيتم ملء الخيارات هنا بناءً على الغرض المختار -->
            </div>
        </div>
    </div>
    
    <!-- ============ الشريط السفلي الزجاجي المعدل ============ -->
    <nav class="bottom-nav">
        <a href="#" class="nav-item" id="mainweb">
            <i class="fas fa-home"></i>
            <span>الرئيسية</span>
        </a>
        <a href="#" class="nav-item" id="bottomNavCompetitions">
            <i class="fas fa-gift"></i>
            <span>المسابقات</span>
            <!-- إضافة شارة الإشعارات فوق أيقونة المسابقات -->
            <div class="nav-badge hidden" id="chatBadge">0</div>
        </a>
        <a href="#" class="nav-item add-center active" id="bottomNavAdd">
            <i class="fas fa-plus-circle"></i>
            <span>أضف إعلانك</span>
        </a>
        <a href="#" class="nav-item" id="bottomNavNotifications">
            <i class="fas fa-bell"></i>
            <span>الإشعارات</span>
            <div class="nav-badge hidden" id="notificationsBadge">0</div>
        </a>
        <a href="#" class="nav-item" id="bottomNavAccount">
            <i class="fas fa-user"></i>
            <span>حسابي</span>
        </a>
    </nav>

    <script>
        // ============ تهيئة Firebase ============
        const firebaseConfig = {
        apiKey: "AIzaSyDZFR9qYKG3vbrrwhNIpy7N3Rfl4J5bxzA",
        authDomain: "marjan-88c6e.firebaseapp.com",
        projectId: "marjan-88c6e",
        storageBucket: "marjan-88c6e.firebasestorage.app",
        messagingSenderId: "92987465899",
        appId: "1:92987465899:web:f91398c67f4812b67e57ee",
        measurementId: "G-FX97RGZRPT"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        // تهيئة الخدمات التي سنستخدمها
        const db = firebase.firestore(); // قاعدة البيانات
        const storage = firebase.storage(); // التخزين

        // عناصر DOM
        const categorySelect = document.getElementById('categorySelect');
        const purposeSelect = document.getElementById('purposeSelect');
        const locationSelect = document.getElementById('locationSelect');
        const categoryPopup = document.getElementById('categoryPopup');
        const purposePopup = document.getElementById('purposePopup');
        const locationPopup = document.getElementById('locationPopup');
        const closeCategoryPopup = document.getElementById('closeCategoryPopup');
        const closePurposePopup = document.getElementById('closePurposePopup');
        const closeLocationPopup = document.getElementById('closeLocationPopup');
        const purposeOptionsContainer = document.getElementById('purposeOptionsContainer');
        const saveBtn = document.getElementById('saveBtn');
        const publishBtn = document.getElementById('publishBtn');
        const successMessage = document.getElementById('successMessage');
        const waitingMessage = document.getElementById('waitingMessage');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        const formMainTitle = document.getElementById('formMainTitle');
        const cityInput = document.getElementById('cityInput'); // إضافة هذا السطر
        
        // عناصر جديدة للوظائف
        const jobTypeGroup = document.getElementById('jobTypeGroup');
        const jobTypeSelect = document.getElementById('jobTypeSelect');
        const jobTypePopup = document.getElementById('jobTypePopup');
        const closeJobTypePopup = document.getElementById('closeJobTypePopup');
        
        const jobFieldGroup = document.getElementById('jobFieldGroup');
        const jobFieldSelect = document.getElementById('jobFieldSelect');
        const jobFieldPopup = document.getElementById('jobFieldPopup');
        const closeJobFieldPopup = document.getElementById('closeJobFieldPopup');
        
        const salaryGroup = document.getElementById('salaryGroup');
        const minSalary = document.getElementById('minSalary');
        const maxSalary = document.getElementById('maxSalary');
        
        const experienceGroup = document.getElementById('experienceGroup');
        const experienceYears = document.getElementById('experienceYears');
        
        // عناصر جديدة للسيارات
        const priceGroup = document.getElementById('priceGroup');
        const carPrice = document.getElementById('carPrice');
        
        // عناصر جديدة للعقارات
        const realestateGroup = document.getElementById('realestateGroup');
        const propertyTypeGroup = document.getElementById('propertyTypeGroup');
        const propertyTypeSelect = document.getElementById('propertyTypeSelect');
        const propertyTypePopup = document.getElementById('propertyTypePopup');
        const closePropertyTypePopup = document.getElementById('closePropertyTypePopup');
        const roomsCount = document.getElementById('roomsCount');
        const bathroomsCount = document.getElementById('bathroomsCount');
        const propertyArea = document.getElementById('propertyArea');
        const propertyPrice = document.getElementById('propertyPrice');
        
        // عناصر جديدة للخدمات
        const servicesGroup = document.getElementById('servicesGroup');
        const serviceMinPrice = document.getElementById('serviceMinPrice');
        const serviceMaxPrice = document.getElementById('serviceMaxPrice');
        const minRating = document.getElementById('minRating');
        const maxRating = document.getElementById('maxRating');
        const deliveryTime = document.getElementById('deliveryTime');
        
        // عناصر جديدة للمنوعات
        const subCategoryGroup = document.getElementById('subCategoryGroup');
        const subCategorySelect = document.getElementById('subCategorySelect');
        const subCategoryPopup = document.getElementById('subCategoryPopup');
        const closeSubCategoryPopup = document.getElementById('closeSubCategoryPopup');
        const subCategoryOptions = document.getElementById('subCategoryOptions');
        const miscellaneousPriceGroup = document.getElementById('miscellaneousPriceGroup');
        const miscellaneousPrice = document.getElementById('miscellaneousPrice');
        
        // متغير لتخزين الصور والفيديوهات
        let uploadedMedia = [];
        let uploadedMediaFiles = []; // تخزين الملفات الأصلية للرفع إلى Firebase
        
        // تعريف أغراض كل قسم
        const purposeOptions = {
            "وظائف": ["وظيفة دائمة", "وظيفة مؤقتة", "عمل حر", "تدريب", "وظيفة عن بعد"],
            "عقارات": ["بيع", "شراء", "إيجار", "mبادلة", "استشارات عقارية"],
            "سيارات": ["بيع", "شراء", "إيجار", "مبادلة", "قطع غيار", "صيانة وخدمات"],
            "خدمات": ["دروس خصوصية","نقل عفش","استقدام عمالة","المباني و المنازل","خدمات تنظيف","دعاية و اعلان","نقل و توصيل","تأجير سيارات","خدمات السيارات","تنظيم حفلات","طبخ منزلي","صحة و جمال","شحن","اتصالات","انترنت","موارد بشرية","تاكسي و توصيل","مفقودات","mقاولات","خدمات الصيانة","اعمال و استثمار","تخليص معاملات","خدمات عقارية","محاماة و قانون","ضريبة و مال","mهارات و تدريب","خدمات احترافية","خدمات زراعية","mكافحة الحشرات","خدمات عامة","سياحة و سفر","ترجمة","حواسيب","تسلية","mمتلكات","حراسة و أمن"],
            "منوعات": ["الكترونيات", "لابتوب و كمبيوتر", "موبايل و تابلت", "العاب الفيديو و الاطفال", "المنزل و الحديقة", "ازياء - موضة نسائية", "ازياء - موضة رجالية", "لوازم الاطفال و الالعاب", "شركات - معدات مهنية"],
            "تعارف": ["صداقة", "زواج", "نشاطات اجتماعية", "تبادل ثقافي", "أخرى"]
        };

        // تعريف الخيارات الفرعية للمنوعات
        const subCategoryOptionsData = {
            "الكترونيات": ["الكل", "تلفزيون", "شاشات", "اجهزه المطبخ الصغيره", "ثلاجات", "فريزر", "غسالات", "جلايات", "افران", "ميكرويف", "مكيفات", "كاميرات وتصوير", "رسيفر", "صوتيات وفيديوهات", "اجهزه منزليه", "اجهزه العنايه شخصيه", "دفايات", "سخانات", "مكابس كهربائيه", "كولر", "فلاتر ماء", "انظمه حمايه ومراقبه", "هواتف و قطع غيار"],
            "لابتوب و كمبيوتر": ["الكل", "لابتوب", "كمبيوتر", "كمبيوتر العاب", "طابعات ", "قطع اكسسوارات", "اكسسوارات", "اجهزه تخزين", "مودم", "سيرفرات", "بروجكتر", "برامج", "اثاث كمpiوتر", "نقاط بيع"],
            "موبايل و تابلت": ["الكل", "موبايل", "تابلت", "ساعات ذكيه", "سماعات", "واقي شاشات", "كفرات", "كوابل", "شواحن", "قطع غيار", "ارقام هواتف مميزه"],
            "العاب الفيديو و الاطفال": ["الكل", "اجهزه العاب", "العاب فيديو", "اجهزه التحكم", "العاب", "اكسسوارات", "بطاقات شراء", "بيع حسابات"],
            "المنزل و الحديقة": ["الكل", "اثاث غرف جلوس", "اثاس غرف نوم", "اثاث غرف سفره", "منسوجات", "الحديقه", "نplantات", "mطابخ", "ادوات المطبخ", "حمامات"],
            "ازياء - موضة نسائية": ["الكل", "ملابس", "احذيه نسائيه", "ساعات", "اكسسوارات", "مجوهرات", "حقائب وشنط", "عطور وبخور", "مستحضرات تجميل"],
            "ازياء - موضة رجالية": ["الكل", "ملابس الرجالي", "احذيه رجالي", "ساعات رجali", "اكسسوارات رجالي", "mستحضرات عنaيه شخصيه"],
            "لوازم الاطفال و الالعاب": ["الكل", "اثاث وغرف نوم اطفال", "mستلزمات اطفال", "ملابس واحذيه للاطفال"],
            "شركات - معدات مهنية": ["الكل", "mعدات مطاعm", "mستلزمات محلات تجاريه", "اجهزه طبيه", "mستلزمات و معدات طبيه", "ادوات ومواد البناء", "mعدات يدوية", "مشاريع استثماريه", "mعدات المصانع", "معدات ومستلزمات التنظيف", "mعدات ومستلزمات خياطه"]
        };
        
        // ============ تحميل بيانات الإعلان للتعديل ============
        let isEditing = false;
        let editingAdId = null;
        let editingAdCategory = null;
        let originalAdData = null;
        
        // التحقق مما إذا كان هناك إعلان للتعديل
        // التحقق مما إذا كان هناك إعلان للتعديل
        // تحسين عملية تحميل البيانات للتعديل
        // التحقق مما إذا كان هناك إعلان للتعديل
        document.addEventListener('DOMContentLoaded', function() {
            // التحقق من وضع التعديل
            const urlParams = new URLSearchParams(window.location.search);
            const isEditMode = urlParams.get('edit') === 'true';

            if (isEditMode) {
                // تغيير العنوان إلى "تعديل الإعلان"
                const formTitle = document.getElementById('formMainTitle');
                if (formTitle) {
                    formTitle.textContent = 'تعديل الإعلان';
                }
                
                // تحميل بيانات الإعلان
                const editAdId = urlParams.get('id');
                const editAdCategory = urlParams.get('category');
                
                if (editAdId && editAdCategory) {
                    loadAdFromFirebase(editAdId, editAdCategory);
                }
            }
            // التحقق من وجود معلمة edit في عنوان URL
            const mainweb = document.getElementById('mainweb');
            const competitions = document.getElementById('bottomNavCompetitions');
            const notifications = document.getElementById('bottomNavNotifications');
            const account = document.getElementById('bottomNavAccount');
            const addBtn = document.getElementById('bottomNavAdd');
            
            if (mainweb) {
                mainweb.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.location.href = 'index.html';
                });
            }
            
            if (competitions) {
                competitions.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.location.href = 'chat.html';
                });
            }
            
            if (notifications) {
                notifications.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.location.href = 'Notifications.html';
                });
            }
            
            if (account) {
                account.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.location.href = 'Account.html';
                });
            }
            // إضافة هذا الجزء للاستماع لتحديثات الإشعارات
            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    loadUserNotifications();
                    listenToNotificationsUpdates();
                    listenToGlobalChat();
                }
            });
            const saveBtnElement = document.getElementById('saveBtn');
            const publishBtnElement = document.getElementById('publishBtn');

            if (saveBtnElement) {
                saveBtnElement.addEventListener('click', () => saveAd(false));
            }

            if (publishBtnElement) {
                publishBtnElement.addEventListener('click', () => saveAd(true));
            }
        });
        function listenToGlobalChat() {
            db.collection('global_chat')
                .orderBy('timestamp', 'desc')
                .onSnapshot(snapshot => {
                    globalMessages = [];
                    snapshot.forEach(doc => {
                        globalMessages.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    updateChatBadge();
                });
        }
        function updateChatBadge() {
            const readMessages = JSON.parse(localStorage.getItem('readMessages')) || [];
            const unreadCount = globalMessages.filter(msg => 
                msg.type === 'admin_message' && !readMessages.includes(msg.id)
            ).length;
            
            const badge = document.getElementById('chatBadge');
            if (badge) {
                if (unreadCount > 0) {
                    badge.textContent = unreadCount > 99 ? '99+' : String(unreadCount);
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }
        }

        // دالة لتحميل معاينات الوسائط
        // دالة لتحميل معاينات الوسائط
        // دالة لتحميل معاينات الوسائط (مصححة)
        function loadMediaPreviews(media) {
            uploadedMedia = media;
            const previewContainer = document.getElementById('mediaPreviewContainer');
            const previewsContainer = document.getElementById('mediaPreviews');
            
            if (media.length > 0) {
                previewContainer.style.display = 'block';
                previewsContainer.innerHTML = '';
                
                media.forEach((mediaItem, index) => {
                    if (mediaItem.type === 'image') {
                        const previewDiv = document.createElement('div');
                        previewDiv.className = 'image-preview';
                        previewDiv.style.backgroundImage = `url(${mediaItem.url || mediaItem.data})`;
                        
                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'remove-image';
                        removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                        
                        removeBtn.onclick = function(event) {
                            event.stopPropagation();
                            previewDiv.remove();
                            uploadedMedia.splice(index, 1);
                            
                            if (uploadedMedia.length === 0) {
                                previewContainer.style.display = 'none';
                            }
                        };
                        
                        previewDiv.appendChild(removeBtn);
                        previewsContainer.appendChild(previewDiv);
                    } else if (mediaItem.type === 'video') {
                        const previewDiv = document.createElement('div');
                        previewDiv.className = 'video-preview';
                        
                        const videoElement = document.createElement('video');
                        videoElement.src = mediaItem.url || mediaItem.data;
                        videoElement.controls = true;
                        videoElement.style.width = '100%';
                        videoElement.style.height = '100%';
                        videoElement.style.objectFit = 'cover';
                        
                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'remove-image';
                        removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                        
                        removeBtn.onclick = function(event) {
                            event.stopPropagation();
                            previewDiv.remove();
                            uploadedMedia.splice(index, 1);
                            
                            if (uploadedMedia.length === 0) {
                                previewContainer.style.display = 'none';
                            }
                        };
                        
                        previewDiv.appendChild(videoElement);
                        previewDiv.appendChild(removeBtn);
                        previewsContainer.appendChild(previewDiv);
                    }
                });
            }
        }

        // دالة لتعبئة حقول النموذج
        // دالة لتعبئة حقول النموذج
        function fillFormFields(adToEdit) {
            document.getElementById('adTitle').value = adToEdit.title || '';
            categorySelect.textContent = adToEdit.category || 'اختر القسم المناسب';
            
            // تعبئة الحقول الخاصة بالوظائف
            if (adToEdit.category === 'وظائف') {
                jobTypeGroup.classList.remove('hidden');
                jobTypeSelect.textContent = adToEdit.jobType || 'اختر نوع الإعلان';
                
                if (adToEdit.jobField) {
                    jobFieldGroup.classList.remove('hidden');
                    jobFieldSelect.textContent = adToEdit.jobField;
                }
                
                if (adToEdit.minSalary || adToEdit.maxSalary) {
                    salaryGroup.classList.remove('hidden');
                    document.getElementById('minSalary').value = adToEdit.minSalary || '';
                    document.getElementById('maxSalary').value = adToEdit.maxSalary || '';
                }
                
                if (adToEdit.experience) {
                    experienceGroup.classList.remove('hidden');
                    document.getElementById('experienceYears').value = adToEdit.experience;
                }
            }
            
            // تعبئة الحقول الخاصة بالعقارات
            if (adToEdit.category === 'عقارات') {
                realestateGroup.classList.remove('hidden');
                propertyTypeGroup.classList.remove('hidden');
                propertyTypeSelect.textContent = adToEdit.propertyType || 'اختر نوع العقار';
                document.getElementById('roomsCount').value = adToEdit.rooms || '';
                document.getElementById('bathroomsCount').value = adToEdit.bathrooms || '';
                document.getElementById('propertyArea').value = adToEdit.area || '';
                document.getElementById('propertyPrice').value = adToEdit.price || '';
            }
            
            // تعبئة الحقول الخاصة بالسيارات
            if (adToEdit.category === 'سيارات') {
                priceGroup.classList.remove('hidden');
                document.getElementById('carPrice').value = adToEdit.price || '';
            }
            
            // تعبئة الحقول الخاصة بالخدمات
            if (adToEdit.category === 'خدمات') {
                servicesGroup.classList.remove('hidden');
                document.getElementById('serviceMinPrice').value = adToEdit.serviceMinPrice || '';
                document.getElementById('serviceMaxPrice').value = adToEdit.serviceMaxPrice || '';
                document.getElementById('minRating').value = adToEdit.minRating || '';
                document.getElementById('maxRating').value = adToEdit.maxRating || '';
                document.getElementById('deliveryTime').value = adToEdit.deliveryTime || '';
                
                // تعبئة الخدمات الإضافية
                if (adToEdit.extraServices) {
                    adToEdit.extraServices.forEach(service => {
                        const checkbox = document.querySelector(`input[name="extraServices"][value="${service}"]`);
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    });
                }
            }

            // تعبئة الحقول الخاصة بالمنوعات
            if (adToEdit.category === 'منوعات') {
                subCategoryGroup.classList.remove('hidden');
                subCategorySelect.textContent = adToEdit.subCategory || 'اختر المجال';
                miscellaneousPriceGroup.classList.remove('hidden');
                document.getElementById('miscellaneousPrice').value = adToEdit.price || '';
            }
            
            // === داخل fillFormFields(adToEdit) بعد purposeSelect ===
            purposeSelect.textContent = adToEdit.purpose || 'اختر الغرض من الإعلان';

            // نقرأ البلد والمدينة بمرونة: إما من الحقول الجديدة country/city أو نفصل الحقل القديم location
            let country = adToEdit.country || '';
            let city = adToEdit.city || '';

            if ((!country || !city) && adToEdit.location) {
                // نفصل على الفواصل الشائعة (، , - – —) لنتعامل مع الصيغ القديمة
                const parts = adToEdit.location.split(/,| - |–|—/).map(p => p.trim()).filter(Boolean);
                if (parts.length >= 2) {
                    // الحالة الشائعة القديمة عند حفظك: "المدينة, الدولة"
                    // افترضنا أن الجزء الأول مدينة والجزء/الأجزاء التالية دولة
                    city = cityé || parts[0];
                    country = country || parts.slice(1).join(', ');
                } else if (parts.length === 1) {
                    // غير معروف: اعتبره دولة أولاً
                    country = country || parts[0];
                }
            }

            // عرض الدولة في حقل الاختيار، والمدينة في حقل النص
            locationSelect.textContent = country || 'حدد الدولة';
            cityInput.value = city || '';

            // باقي الحقول
            document.getElementById('adDescription').value = adToEdit.description || '';
            document.getElementById('phoneNumber').value = adToEdit.phone || '';

        }
        function updateNavBadge(type, notifications) {
            const id = type === 'notifications' ? 'notificationsBadge' : null;
            if (!id) return;

            const badge = document.getElementById(id);
            if (!badge) return;

            // حساب الإشعارات غير المقروءة فقط
            const unreadCount = notifications.filter(notification => !notification.read).length;

            if (unreadCount > 0) {
                badge.textContent = unreadCount > 99 ? '99+' : String(unreadCount);
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }
        function loadUserNotifications() {
            const user = firebase.auth().currentUser;
            
            if (!user) {
                return;
            }

            db.collection('users')
                .where('email', '==', user.email)
                .limit(1)
                .get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        return;
                    }

                    const doc = snapshot.docs[0];
                    const userData = doc.data();
                    const notifications = userData.notifications || [];

                    updateNavBadge('notifications', notifications);
                })
                .catch(error => {
                    console.error('خطأ في تحميل الإشعارات:', error);
                });
        }
        function listenToNotificationsUpdates() {
            const user = firebase.auth().currentUser;
            if (!user) return;

            db.collection('users')
                .where('email', '==', user.email)
                .limit(1)
                .onSnapshot(snapshot => {
                    if (!snapshot.empty) {
                        const doc = snapshot.docs[0];
                        const notifications = doc.data().notifications || [];
                        updateNavBadge('notifications', notifications);
                    }
                });
        }
        // بعد نجاح إنشاء الإعلان
        async function handleAdCreationSuccess() {
            const currentUserUID = firebase.auth().currentUser?.uid;
            
            if (!currentUserUID) return;
            
            try {
                // الحصول على بيانات المستخدم الحالي
                const userDoc = await db.collection('users').doc(currentUserUID).get();
                
                if (!userDoc.exists) return;
                
                const userData = userDoc.data();
                const referredBy = userData.referredBy;
                const referredCompetition = userData.referredCompetition;
                
                // التحقق إذا كان المستخدم محال من شخص آخر
                if (referredBy && referredCompetition) {
                    // الحصول على بيانات المُحيل
                    const referrerDoc = await db.collection('users').doc(referredBy).get();
                    
                    if (referrerDoc.exists) {
                        const referrerData = referrerDoc.data();
                        const competitionData = referrerData.competitions?.[referredCompetition] || {};
                        const currentReferrals = competitionData.successfulReferrals || [];
                        
                        // التحقق إذا لم يتم إضافة المستخدم مسبقاً
                        const alreadyAdded = currentReferrals.some(ref => ref.uid === currentUserUID);
                        
                        if (!alreadyAdded) {
                            // إضافة المستخدم إلى قائمة الإحالات الناجحة
                            const newReferral = {
                                uid: currentUserUID,
                                name: `${userData.firstName} ${userData.lastName}`,
                                adCreatedAt: firebase.firestore.Timestamp.now()
                            };
                            
                            currentReferrals.push(newReferral);
                            
                            // حساب النسبة الجديدة
                            const newPercentage = Math.min(currentReferrals.length * 20, 100);
                            
                            // تحديث بيانات المُحيل
                            await db.collection('users').doc(referredBy).update({
                                [`competitions.${referredCompetition}.successfulReferrals`]: currentReferrals,
                                [`competitions.${referredCompetition}.percentage`]: newPercentage
                            });
                            
                            console.log('تم تحديث نسبة الإكمال للمُحيل:', newPercentage);
                            
                            // إزالة بيانات الإحالة من المستخدم الحالي لمنع التكرار
                            await db.collection('users').doc(currentUserUID).update({
                                referredBy: firebase.firestore.FieldValue.delete(),
                                referredCompetition: firebase.firestore.FieldValue.delete()
                            });
                        }
                    }
                }
            } catch (error) {
                console.error('خطأ في معالجة الإحالة بعد إنشاء الإعلان:', error);
            }
        }

        // دالة لتحميل الإعلان من Firebase
        async function loadAdFromFirebase(adId, category) {
            try {
                // الحصول على معرف Firebase من localStorage إذا كان متاحًا
                const firebaseId = localStorage.getItem('editAdFirebaseId');
                
                if (firebaseId) {
                    const doc = await db.collection("ads").doc(firebaseId).get();
                    
                    if (doc.exists) {
                        const adToEdit = doc.data();
                        adToEdit.id = doc.id;
                        adToEdit.firebaseId = doc.id;
                        
                        originalAdData = adToEdit;
                        
                        // تعبئة الحقول ببيانات الإعلان
                        fillFormFields(adToEdit);
                        
                        // تحميل الوسائط إذا كانت موجودة
                        if (adToEdit.media && adToEdit.media.length > 0) {
                            loadMediaPreviews(adToEdit.media);
                        }
                        
                        // حفظ البيانات في localStorage للاستخدام المستقبلي
                        localStorage.setItem('editAdData', JSON.stringify(adToEdit));
                    }
                } else {
                    // البحث في جميع الإعلانات إذا لم يكن هناك معرف Firebase
                    const snapshot = await db.collection("ads")
                        .where("id", "==", parseInt(adId))
                        .where("category", "==", category)
                        .get();
                        
                    if (!snapshot.empty) {
                        snapshot.forEach(doc => {
                            const adToEdit = doc.data();
                            adToEdit.id = doc.id;
                            adToEdit.firebaseId = doc.id;
                            
                            originalAdData = adToEdit;
                            
                            // تعبئة الحقول ببيانات الإعلان
                            fillFormFields(adToEdit);
                            
                            // تحميل الوسائط إذا كانت موجودة
                            if (adToEdit.media && adToEdit.media.length > 0) {
                                loadMediaPreviews(adToEdit.media);
                            }
                            
                            // حفظ البيانات في localStorage للاستخدام المستقبلي
                            localStorage.setItem('editAdData', JSON.stringify(adToEdit));
                            localStorage.setItem('editAdFirebaseId', doc.id);
                        });
                    } else {
                        showError('لم يتم العثور على الإعلان في النظام');
                    }
                }
            } catch (error) {
                console.error("Error loading ad from Firebase:", error);
                showError('حدث خطأ في تحميل بيانات الإعلان');
            }
        }
        // ✅ معالجة تحديث حالة الإحالة عند نشر الإعلان
        async function updateReferralStatus(currentUserUID) {
            try {
                console.log('🔍 جاري التحقق من حالة الإحالة...');
                
                // قراءة بيانات المستخدم الحالي
                const userDoc = await db.collection('users').doc(currentUserUID).get();
                
                if (!userDoc.exists) {
                    console.log('⚠️ بيانات المستخدم غير موجودة');
                    return;
                }
                
                const userData = userDoc.data();
                
                // التحقق من وجود إحالة
                if (!userData.referredBy || !userData.referredCompetition) {
                    console.log('ℹ️ المستخدم غير مُحال من أحد');
                    return;
                }
                
                // التحقق من عدم نشر إعلان سابقاً
                if (userData.hasPublishedAd === true) {
                    console.log('ℹ️ المستخدم نشر إعلان من قبل');
                    return;
                }
                
                const referrerUID = userData.referredBy;
                const competitionId = userData.referredCompetition;
                
                console.log('✅ المستخدم مُحال من:', referrerUID);
                console.log('📋 المسابقة:', competitionId);
                
                // قراءة بيانات المُحيل
                const referrerDoc = await db.collection('users').doc(referrerUID).get();
                
                if (!referrerDoc.exists) {
                    console.log('⚠️ بيانات المُحيل غير موجودة');
                    return;
                }
                
                const referrerData = referrerDoc.data();
                const competitions = referrerData.competitions || {};
                
                if (!competitions[competitionId]) {
                    console.log('⚠️ قسم المسابقة غير موجود');
                    return;
                }
                
                // البحث عن المستخدم في قائمة المحالين وتحديث حالته
                const successfulReferrals = competitions[competitionId].successfulReferrals || [];
                
                let updated = false;
                const updatedReferrals = successfulReferrals.map(referral => {
                    if (referral.uid === currentUserUID) {
                        updated = true;
                        return {
                            ...referral,
                            status: 'success', // ✅ تحديث الحالة إلى نجاح
                            publishedAt: new Date().toISOString()
                        };
                    }
                    return referral;
                });
                
                if (!updated) {
                    console.log('⚠️ المستخدم غير موجود في قائمة المحالين');
                    return;
                }
                
                // حساب نسبة الإكمال الجديدة
                const successCount = updatedReferrals.filter(r => r.status === 'success').length;
                const totalRequired = 1; // يمكنك تغيير هذا الرقم حسب متطلباتك
                const newPercentage = Math.round((successCount / totalRequired) * 100);
                
                console.log(`📊 عدد الإحالات الناجحة: ${successCount}/${totalRequired}`);
                console.log(`📈 النسبة الجديدة: ${newPercentage}%`);
                
                // تحديث بيانات المُحيل
                await db.collection('users').doc(referrerUID).update({
                    [`competitions.${competitionId}.successfulReferrals`]: updatedReferrals,
                    [`competitions.${competitionId}.percentage`]: newPercentage
                });
                
                console.log('✅ تم تحديث حالة الإحالة بنجاح');
                
                // تحديث حالة المستخدم الحالي
                await db.collection('users').doc(currentUserUID).update({
                    hasPublishedAd: true
                });
                
                console.log('✅ تم تحديث حالة المستخدم الحالي');
                
                // يمكنك إضافة إشعار للمستخدم المُحيل هنا
                await sendNotificationToReferrer(referrerUID, userData, competitionId);
                
            } catch (error) {
                console.error('❌ خطأ في تحديث حالة الإحالة:', error);
            }
        }

        // ✅ دالة إرسال إشعار للمُحيل (اختيارية)
        async function sendNotificationToReferrer(referrerUID, newUserData, competitionId) {
            try {
                const notification = {
                    type: 'referral_success',
                    title: '🎉 إحالة ناجحة!',
                    message: `قام ${newUserData.firstName} ${newUserData.lastName} بنشر إعلان`,
                    competitionId: competitionId,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    read: false
                };
                
                await db.collection('users').doc(referrerUID).update({
                    notifications: firebase.firestore.FieldValue.arrayUnion(notification)
                });
                
                console.log('✅ تم إرسال إشعار للمُحيل');
            } catch (error) {
                console.error('❌ خطأ في إرسال الإشعار:', error);
            }
        }
        
        // فتح نافذة اختيار القسم
        categorySelect.addEventListener('click', function() {
            categoryPopup.classList.add('active');
        });
        
        // فتح نافذة اختيار نوع الإعلان للوظائف
        jobTypeSelect.addEventListener('click', function() {
            jobTypePopup.classList.add('active');
        });
        
        // فتح نافذة اختيار المجال المهني
        jobFieldSelect.addEventListener('click', function() {
            jobFieldPopup.classList.add('active');
        });
        
        // فتح نافذة اختيار نوع العقار
        propertyTypeSelect.addEventListener('click', function() {
            propertyTypePopup.classList.add('active');
        });
        
        // فتح نافذة اختيار الغرض
        purposeSelect.addEventListener('click', function() {
            const selectedCategory = categorySelect.textContent;
            
            if (selectedCategory === 'اختر القسم المناسب') {
                showError('يرجى اختيار القسم أولاً');
                return;
            }
            
            // ملء خيارات الغرض بناءً على القسم المختار
            purposeOptionsContainer.innerHTML = '';
            
            purposeOptions[selectedCategory].forEach(purpose => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'purpose-option';
                optionDiv.setAttribute('data-value', purpose);
                optionDiv.textContent = purpose;
                purposeOptionsContainer.appendChild(optionDiv);
            });
            
            purposePopup.classList.add('active');
        });
        
        // فتح نافذة اختيار المدينة
        locationSelect.addEventListener('click', function() {
            locationPopup.classList.add('active');
        });

        // فتح نافذة اختيار المجال للمنوعات
        subCategorySelect.addEventListener('click', function() {
            subCategoryPopup.classList.add('active');
        });
        
        // إغلاق النوافذ
        closeCategoryPopup.addEventListener('click', function() {
            categoryPopup.classList.remove('active');
        });
        
        closeJobTypePopup.addEventListener('click', function() {
            jobTypePopup.classList.remove('active');
        });
        
        closeJobFieldPopup.addEventListener('click', function() {
            jobFieldPopup.classList.remove('active');
        });
        
        closePropertyTypePopup.addEventListener('click', function() {
            propertyTypePopup.classList.remove('active');
        });
        
        closePurposePopup.addEventListener('click', function() {
            purposePopup.classList.remove('active');
        });
        
        closeLocationPopup.addEventListener('click', function() {
            locationPopup.classList.remove('active');
        });

        closeSubCategoryPopup.addEventListener('click', function() {
            subCategoryPopup.classList.remove('active');
        });
        
        // اختيار خيار من النوافذ
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('purpose-option')) {
                const value = e.target.getAttribute('data-value');
                
                if (e.target.closest('#categoryPopup')) {
                    categorySelect.textContent = value;
                    categoryPopup.classList.remove('active');
                    // إعادة تعيين الغرض عند تغيير القسم
                    purposeSelect.textContent = 'اختر الغرض من الإعلان';
                    
                    // التحقق مما إذا كان القسم المختار هو "وظائف"
                    if (value === 'وظائف') {
                        jobTypeGroup.classList.remove('hidden');
                        priceGroup.classList.add('hidden');
                        realestateGroup.classList.add('hidden');
                        propertyTypeGroup.classList.add('hidden');
                        servicesGroup.classList.add('hidden');
                        subCategoryGroup.classList.add('hidden');
                        miscellaneousPriceGroup.classList.add('hidden');
                    } else if (value === 'عقارات') {
                        jobTypeGroup.classList.add('hidden');
                        jobFieldGroup.classList.add('hidden');
                        salaryGroup.classList.add('hidden');
                        experienceGroup.classList.add('hidden');
                        priceGroup.classList.add('hidden');
                        realestateGroup.classList.remove('hidden');
                        propertyTypeGroup.classList.remove('hidden');
                        servicesGroup.classList.add('hidden');
                        subCategoryGroup.classList.add('hidden');
                        miscellaneousPriceGroup.classList.add('hidden');
                    } else if (value === 'سيارات') {
                        jobTypeGroup.classList.add('hidden');
                        jobFieldGroup.classList.add('hidden');
                        salaryGroup.classList.add('hidden');
                        experienceGroup.classList.add('hidden');
                        realestateGroup.classList.add('hidden');
                        propertyTypeGroup.classList.add('hidden');
                        priceGroup.classList.remove('hidden');
                        servicesGroup.classList.add('hidden');
                        subCategoryGroup.classList.add('hidden');
                        miscellaneousPriceGroup.classList.add('hidden');
                    } else if (value === 'خدمات') {
                        jobTypeGroup.classList.add('hidden');
                        jobFieldGroup.classList.add('hidden');
                        salaryGroup.classList.add('hidden');
                        experienceGroup.classList.add('hidden');
                        realestateGroup.classList.add('hidden');
                        propertyTypeGroup.classList.add('hidden');
                        priceGroup.classList.add('hidden');
                        servicesGroup.classList.remove('hidden');
                        subCategoryGroup.classList.add('hidden');
                        miscellaneousPriceGroup.classList.add('hidden');
                    } else if (value === 'منوعات') {
                        jobTypeGroup.classList.add('hidden');
                        jobFieldGroup.classList.add('hidden');
                        salaryGroup.classList.add('hidden');
                        experienceGroup.classList.add('hidden');
                        priceGroup.classList.add('hidden');
                        realestateGroup.classList.add('hidden');
                        propertyTypeGroup.classList.add('hidden');
                        servicesGroup.classList.add('hidden');
                        subCategoryGroup.classList.remove('hidden');
                        miscellaneousPriceGroup.classList.remove('hidden');
                    } else {
                        jobTypeGroup.classList.add('hidden');
                        jobFieldGroup.classList.add('hidden');
                        salaryGroup.classList.add('hidden');
                        experienceGroup.classList.add('hidden');
                        priceGroup.classList.add('hidden');
                        realestateGroup.classList.add('hidden');
                        propertyTypeGroup.classList.add('hidden');
                        servicesGroup.classList.add('hidden');
                        subCategoryGroup.classList.add('hidden');
                        miscellaneousPriceGroup.classList.add('hidden');
                    }
                } else if (e.target.closest('#jobTypePopup')) {
                    jobTypeSelect.textContent = value;
                    jobTypePopup.classList.remove('active');
                    
                    // إظهار المجال المهني عند اختيار نوع الإعلان
                    jobFieldGroup.classList.remove('hidden');
                    
                    // إظهار حقلي الراتب والخبرة عند اختيار نوع معين
                    if (value === 'إعلان عن وظيفة شاغرة' || value === 'ابحث عن عمل') {
                        salaryGroup.classList.remove('hidden');
                        experienceGroup.classList.remove('hidden');
                    } else {
                        salaryGroup.classList.add('hidden');
                        experienceGroup.classList.add('hidden');
                    }
                } else if (e.target.closest('#jobFieldPopup')) {
                    jobFieldSelect.textContent = value;
                    jobFieldPopup.classList.remove('active');
                } else if (e.target.closest('#propertyTypePopup')) {
                    propertyTypeSelect.textContent = value;
                    propertyTypePopup.classList.remove('active');
                } else if (e.target.closest('#purposePopup')) {
                    purposeSelect.textContent = value;
                    purposePopup.classList.remove('active');

                    // إذا كان القسم منوعات، قم بملء خيارات المجال الفرعي
                    if (categorySelect.textContent === 'منوعات') {
                        subCategoryOptions.innerHTML = '';
                        
                        if (subCategoryOptionsData[value]) {
                            subCategoryOptionsData[value].forEach(option => {
                                const optionDiv = document.createElement('div');
                                optionDiv.className = 'purpose-option';
                                optionDiv.setAttribute('data-value', option);
                                optionDiv.textContent = option;
                                subCategoryOptions.appendChild(optionDiv);
                            });
                        }
                    }
                } else if (e.target.closest('#locationPopup')) {
                    locationSelect.textContent = value;
                    locationPopup.classList.remove('active');
                } else if (e.target.closest('#subCategoryPopup')) {
                    subCategorySelect.textContent = value;
                    subCategoryPopup.classList.remove('active');
                }
            }
        });
        
        // إغلاق النوافذ عند النقر خارجها
        window.addEventListener('click', function(e) {
            if (e.target === categoryPopup) {
                categoryPopup.classList.remove('active');
            }
            if (e.target === jobTypePopup) {
                jobTypePopup.classList.remove('active');
            }
            if (e.target === jobFieldPopup) {
                jobFieldPopup.classList.remove('active');
            }
            if (e.target === propertyTypePopup) {
                propertyTypePopup.classList.remove('active');
            }
            if (e.target === purposePopup) {
                purposePopup.classList.remove('active');
            }
            if (e.target === locationPopup) {
                locationPopup.classList.remove('active');
            }
            if (e.target === subCategoryPopup) {
                subCategoryPopup.classList.remove('active');
            }
        });
        
        // تفاعل الشريط السفلي
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
                document.querySelectorAll('.nav-item').forEach(navItem => {
                    navItem.classList.remove('active');
                });
                this.classList.add('active');
            });
        });
        
        
        
        // دالة لعرض رسالة النجاح
        function showSuccessMessage() {
            successMessage.classList.add('active');
            setTimeout(() => {
                successMessage.classList.remove('active');
            }, 3000);
        }
        
        // دالة لعرض رسالة الانتظار
        function showWaitingMessage() {
            waitingMessage.classList.add('active');
        }
        
        // دالة لإخفاء رسالة الانتظار
        function hideWaitingMessage() {
            waitingMessage.classList.remove('active');
        }
        
        // دالة لعرض رسالة الخطأ
        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.add('active');
            setTimeout(() => {
                errorMessage.classList.remove('active');
            }, 3000);
        }
        
        // دالة لتحجيم الصورة
        function resizeImage(file, maxWidth, maxHeight, quality, callback) {
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    let width = img.width;
                    let height = img.height;
                    
                    // الاحتفاظ بالأبعاد الأصلية إذا كانت ضمن الحدود
                    if (width <= maxWidth && height <= maxHeight) {
                        // استخدام جودة عالية للصور الصغيرة
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        const originalQualityImage = canvas.toDataURL('image/jpeg', 0.9);
                        callback(originalQualityImage);
                        return;
                    }
                    // حساب الأبعاد الجديدة مع الحفاظ على التناسب
                    if (width > maxWidth) {
                        height *= maxWidth / width;
                        width = maxWidth;
                    }
                    if (height > maxHeight) {
                        width *= maxHeight / height;
                        height = maxHeight;
                    }
                    
                    // إنشاء عنصر canvas لرسم الصورة المحجمة
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // الحصول على الصورة المحجمة كبيانات base64
                    const resizedImage = canvas.toDataURL('image/jpeg', quality);
                    callback(resizedImage);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        // دالة لمعالجة اختيار الصور
        function handleImageSelection(event) {
            const files = event.target.files;
            
            // تحديد عدد الوسائط (بحد أقصى 4)
            const maxMedia = 4;
            const imageCount = Math.min(files.length, maxMedia - uploadedMedia.length);
            
            if (imageCount > 0) {
                for (let i = 0; i < imageCount; i++) {
                    processImage(files[i]);
                }
            }
        }
        
        // دالة لمعالجة اختيار الفيديو
        // دالة لمعالجة اختيار الفيديو (معدلة)
        // دالة لمعالجة اختيار الفيديو
        function handleVideoSelection(event) {
            const file = event.target.files[0];
            
            if (!file) return;
            
            // التحقق من عدد الوسائط (بحد أقصى 4)
            if (uploadedMedia.length >= 4) {
                showError('يمكنك رفع 4 وسائط كحد أقصى');
                return;
            }
            
            // التحقق من حجم الملف (بحد أقصى 50MB)
            if (file.size > 50 * 1024 * 1024) {
                showError('حجم الفيديو كبير جداً. الحد الأقصى هو 50MB');
                return;
            }
            
            // التحقق من نوع الملف
            if (!file.type.startsWith('video/')) {
                showError('الملف المختار ليس فيديو');
                return;
            }
            
            // حفظ الملف للرفع لاحقاً
            uploadedMediaFiles.push({
                type: 'video',
                file: file
            });
            
            // إنشاء معاينة للفيديو
            const videoURL = URL.createObjectURL(file);
            
            // حفظ للمعاينة فقط
            uploadedMedia.push({
                type: 'video',
                data: videoURL,
                file: file // حفظ المرجع للملف الأصلي
            });
            
            updateMediaPreviews();
        }

        // دالة لتحديث معاينات الوسائط (معدلة لعرض الفيديو بشكل صحيح)
        
        
        // دالة لمعالجة الصور
        function processImage(file) {
            // التحقق من حجم الملف (بحد أقصى 2MB)
            if (file.size > 2 * 1024 * 1024) {
                showError('حجم الصورة كبير جداً. الحد الأقصى هو 2MB');
                return;
            }
            
            // حفظ الملف الأصلي للرفع لاحقاً
            uploadedMediaFiles.push({
                type: 'image',
                file: file
            });
            
            // تحجيم الصورة إلى أبعاد مناسبة وجودة معقولة
            resizeImage(file, 1200, 900, 0.95, function(resizedImage) {
                // حفظ الصورة
                uploadedMedia.push({
                    type: 'image',
                    data: resizedImage
                });
                updateMediaPreviews();
            });
        }
        
        // دالة لتحديث معاينات الوسائط
        // دالة لتحديث معاينات الوسائط (معدلة لعرض الفيديو بشكل صحيح)
        // دالة لتحديث معاينات الوسائط
        // دالة لتحديث معاينات الوسائط (مصححة)
        function updateMediaPreviews() {
            const previewContainer = document.getElementById('mediaPreviewContainer');
            const previewsContainer = document.getElementById('mediaPreviews');
            
            // مسح المعاينات السابقة
            previewsContainer.innerHTML = '';
            
            if (uploadedMedia.length > 0) {
                previewContainer.style.display = 'block';
                
                uploadedMedia.forEach((media, index) => {
                    if (media.type === 'image') {
                        const previewDiv = document.createElement('div');
                        previewDiv.className = 'image-preview';
                        previewDiv.style.backgroundImage = `url(${media.data})`;
                        
                        // زر إزالة الصورة
                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'remove-image';
                        removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                        
                        removeBtn.onclick = function(event) {
                            event.stopPropagation();
                            // تحرير الرابط المؤقت للصور
                            if (media.data.startsWith('blob:')) {
                                URL.revokeObjectURL(media.data);
                            }
                            // إزالة الوسائط من المصفوفات
                            uploadedMedia.splice(index, 1);
                            uploadedMediaFiles.splice(index, 1);
                            
                            // إعادة إنشاء المعاينات
                            updateMediaPreviews();
                        };
                        
                        previewDiv.appendChild(removeBtn);
                        previewsContainer.appendChild(previewDiv);
                    } else if (media.type === 'video') {
                        const previewDiv = document.createElement('div');
                        previewDiv.className = 'video-preview';
                        
                        const videoElement = document.createElement('video');
                        videoElement.src = media.data;
                        videoElement.controls = true;
                        videoElement.style.width = '100%';
                        videoElement.style.height = '100%';
                        videoElement.style.objectFit = 'cover';
                        
                        // زر إزالة الفيديو
                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'remove-image';
                        removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                        
                        removeBtn.onclick = function(event) {
                            event.stopPropagation();
                            // تحرير الرابط المؤقت
                            URL.revokeObjectURL(media.data);
                            // إزالة الوسائط من المصفوفات
                            uploadedMedia.splice(index, 1);
                            uploadedMediaFiles.splice(index, 1);
                            
                            // إعادة إنشاء المعاينات
                            updateMediaPreviews();
                        };
                        
                        previewDiv.appendChild(videoElement);
                        previewDiv.appendChild(removeBtn);
                        previewsContainer.appendChild(previewDiv);
                    }
                });
            } else {
                previewContainer.style.display = 'none';
            }
        }
        
        // دالة للحصول على مفتاح التخزين من اسم القسم
        function getCategoryKey(categoryName) {
            switch(categoryName) {
                case "عقارات":
                    return 'homes';
                case "وظائف":
                    return 'jobs';
                case "سيارات":
                    return 'cars';
                case "خدمات":
                    return 'services';
                case "منوعات":
                    return 'miscellaneous';
                case "تعارف":
                    return 'introduction';
                default:
                    return 'other';
            }
        }
        
        // دالة لرفع الملفات إلى Firebase Storage
        // دالة لرفع الملفات إلى Firebase Storage
        async function uploadMediaToFirebase(docId) {
            const mediaUrls = [];
            
            // إذا لم يكن هناك وسائط، إرجاع مصفوفة فارغة
            if (!uploadedMediaFiles || uploadedMediaFiles.length === 0) {
                return mediaUrls;
            }
            
            for (let i = 0; i < uploadedMediaFiles.length; i++) {
                const media = uploadedMediaFiles[i];
                
                // إذا لم يكن هناك ملف، تخطي
                if (!media || !media.file) {
                    continue;
                }
                
                const mediaRef = storage.ref().child(`ads/${docId}/media_${i}`);
                
                try {
                    // رفع الملف إلى Firebase Storage
                    const snapshot = await mediaRef.put(media.file);
                    
                    // الحصول على رابط التنزيل
                    const downloadURL = await snapshot.ref.getDownloadURL();
                    
                    // إضافة رابط الملف إلى المصفوفة
                    mediaUrls.push({
                        type: media.type,
                        url: downloadURL
                    });
                } catch (error) {
                    console.error('Error uploading media:', error);
                    // لا ترمي خطأ هنا حتى لا تعيق عملية الحفظ
                    // يمكنك إضافة رسالة تحذير بدلاً من ذلك
                    console.warn('فشل في رفع الوسائط، ولكن سيتم حفظ الإعلان بدونها');
                }
            }
            
            return mediaUrls;
        }
        
        // دالة لحفظ الإعلان
        // دالة لحفظ الإعلان
        // دالة لحفظ الإعلان مع خصم النقاط
        // دالة لحفظ الإعلان مع حذف خاصية التحقق من تسجيل الدخول وخصم النقاط
        // دالة لحفظ الإعلان مع التحقق من الرصيد وخصم النقاط
        async function saveAd(isPublish) {
            // الحصول على قيم الحقول
            const adTitle = document.getElementById('adTitle').value;
            const adDescription = document.getElementById('adDescription').value;
            const phoneNumber = document.getElementById('phoneNumber').value;
            const city = cityInput.value;
            
            // التحقق من الحقول المطلوبة
            if (!adTitle || 
                categorySelect.textContent === 'اختر القسم المناسب' || 
                purposeSelect.textContent === 'اختر الغرض من الإعلان' ||
                locationSelect.textContent === 'حدد الدولة' ||
                !city ||
                !adDescription ||
                !phoneNumber) {
                showError('يرجى ملء جميع الحقول المطلوبة');
                return;
            }
            
            // التحقق من صحة رقم الهاتف
            const phoneRegex = /^(\+?249|0)(9|1)[0-9]{8}$/;
            if (!phoneRegex.test(phoneNumber)) {
                showError('يرجى إدخال رقم هاتف سوداني صحيح');
                return;
            }

            // ✅ الحصول على بيانات المستخدم الحالي
            const currentUser = firebase.auth().currentUser;

            if (!currentUser) {
                showError('يرجى تسجيل الدخول أولاً لإضافة إعلان');
                return;
            }

            const userEmail = currentUser.email;
            const userUid = currentUser.uid;

            console.log("📧 بريد المستخدم:", userEmail);
            console.log("🆔 معرف المستخدم:", userUid);

            // ✅ التحقق من وضع التعديل
            const urlParams = new URLSearchParams(window.location.search);
            const isEditMode = urlParams.get('edit') === 'true';
            const editAdFirebaseId = localStorage.getItem('editAdFirebaseId');

            console.log('🔍 وضع التعديل:', isEditMode);
            console.log('🔍 معرف الإعلان للتعديل:', editAdFirebaseId);

            // ✅ التحقق من المستخدم والرصيد (فقط عند النشر وليس التعديل)
            let userDoc = null;
            let userData = null;
            
            if (isPublish && !isEditMode) {
                try {
                    const usersQuery = await db.collection("users")
                        .where("email", "==", userEmail)
                        .limit(1)
                        .get();

                    if (usersQuery.empty) {
                        showError('لم يتم العثور على بيانات المستخدم');
                        return;
                    }

                    userDoc = usersQuery.docs[0];
                    userData = userDoc.data();
                    const currentBalance = userData.currentBalance || 0;

                    if (currentBalance < 10) {
                        showError('رصيدك من النقاط غير كافٍ. تحتاج إلى 10 نقاط لنشر الإعلان انتقل الي صفحة حسابي لشراء نقاط ذهبية');
                        return;
                    }
                } catch (error) {
                    console.error("❌ خطأ في التحقق من رصيد المستخدم:", error);
                    showError('حدث خطأ في التحقق من رصيد النقاط');
                    return;
                }
            }
            
            // تحديث حالة الإحالة إذا كان المستخدم محال
            if (!isEditMode) {
                await updateReferralStatus(currentUser.uid);
            }
            
            // ✅ إنشاء كائن بيانات الإعلان
            const adData = {
                title: adTitle,
                category: categorySelect.textContent,
                purpose: purposeSelect.textContent,
                country: locationSelect.textContent,
                city: cityInput.value,
                location: `${locationSelect.textContent} - ${cityInput.value}`,
                description: adDescription,
                phone: phoneNumber,
                date: isEditMode && originalAdData 
                    ? originalAdData.date 
                    : new Date().toISOString(),
                views: isEditMode && originalAdData ? originalAdData.views : 0,
                status: isPublish ? 'active' : 'pending',
                userEmail: userEmail,
                userUid: userUid
            };

            // إضافة البيانات الخاصة بالوظائف
            if (categorySelect.textContent === 'وظائف') {
                adData.jobType = jobTypeSelect.textContent;
                adData.jobField = jobFieldSelect.textContent;
                
                if (jobTypeSelect.textContent === 'إعلان عن وظيفة شاغرة' || 
                    jobTypeSelect.textContent === 'ابحث عن عمل') {
                    adData.minSalary = minSalary.value;
                    adData.maxSalary = maxSalary.value;
                    adData.experience = experienceYears.value;
                }
            }
            
            // إضافة بيانات العقارات
            if (categorySelect.textContent === 'عقارات') {
                adData.propertyType = propertyTypeSelect.textContent;
                adData.rooms = roomsCount.value;
                adData.bathrooms = bathroomsCount.value;
                adData.area = propertyArea.value;
                adData.price = propertyPrice.value;
            }
            
            // إضافة بيانات السعر للسيارات
            if (categorySelect.textContent === 'سيارات') {
                adData.price = carPrice.value;
            }
            
            // إضافة بيانات الخدمات
            if (categorySelect.textContent === 'خدمات') {
                adData.serviceMinPrice = serviceMinPrice.value;
                adData.serviceMaxPrice = serviceMaxPrice.value;
                adData.minRating = minRating.value;
                adData.maxRating = maxRating.value;
                adData.deliveryTime = deliveryTime.value;
                
                const extraServices = [];
                document.querySelectorAll('input[name="extraServices"]:checked').forEach(checkbox => {
                    extraServices.push(checkbox.value);
                });
                adData.extraServices = extraServices;
            }

            // إضافة بيانات المنوعات
            if (categorySelect.textContent === 'منوعات') {
                adData.subCategory = subCategorySelect.textContent;
                adData.price = miscellaneousPrice.value;
            }
            
            try {
                // عرض رسالة الانتظار عند النشر
                if (isPublish) {
                    showWaitingMessage();
                }
                
                let docRef;
                
                // ✅ التعامل مع التعديل
                if (isEditMode && editAdFirebaseId) {
                    console.log('✏️ تحديث إعلان موجود:', editAdFirebaseId);
                    
                    docRef = db.collection("ads").doc(editAdFirebaseId);
                    
                    // تحديث البيانات فقط
                    await docRef.update(adData);
                    console.log("✅ تم تحديث الإعلان بنجاح");
                    
                } else {
                    // ✅ إنشاء إعلان جديد
                    console.log('➕ إنشاء إعلان جديد');
                    
                    // إضافة معرف فريد للإعلان الجديد
                    adData.id = Date.now();
                    
                    docRef = await db.collection("ads").add(adData);
                    adData.firebaseId = docRef.id;
                    console.log("✅ تم إنشاء إعلان جديد:", docRef.id);
                }

                // رفع الوسائط إذا وجدت
                if (uploadedMediaFiles.length > 0) {
                    try {
                        const mediaUrls = await uploadMediaToFirebase(
                            isEditMode && editAdFirebaseId ? editAdFirebaseId : docRef.id
                        );
                        await db.collection("ads").doc(
                            isEditMode && editAdFirebaseId ? editAdFirebaseId : docRef.id
                        ).update({
                            media: mediaUrls
                        });
                        console.log("✅ تم رفع الوسائط بنجاح");
                    } catch (error) {
                        console.error("❌ خطأ في رفع الوسائط:", error);
                    }
                }

                // ✅ خصم النقاط فقط عند النشر لإعلان جديد (وليس التعديل)
                // ✅ خصم النقاط وتحديث حالة النشر عند النشر لإعلان جديد (وليس التعديل)
                if (isPublish && !isEditMode && userDoc && userData) {
                    try {
                        await db.collection("users").doc(userDoc.id).update({
                            currentBalance: firebase.firestore.FieldValue.increment(-10),
                            hasPublishedAd: true  // ✅ هذا هو المكان الصحيح
                        });
                        console.log("✅ تم خصم 10 نقاط من رصيد المستخدم");
                        console.log("✅ تم تحديث hasPublishedAd إلى true");
                    } catch (error) {
                        console.error("❌ خطأ في خصم النقاط:", error);
                    }
                }
                
                // حفظ في localStorage
                const storageKey = getCategoryKey(categorySelect.textContent);
                let existingAds = JSON.parse(localStorage.getItem(storageKey)) || [];

                if (isEditMode) {
                    // تحديث الإعلان في localStorage
                    const index = existingAds.findIndex(ad => 
                        ad.firebaseId === editAdFirebaseId || 
                        ad.id === parseInt(urlParams.get('id'))
                    );
                    
                    if (index > -1) {
                        existingAds[index] = { ...adData, firebaseId: editAdFirebaseId, media: uploadedMedia };
                    } else {
                        existingAds.push({ ...adData, firebaseId: editAdFirebaseId, media: uploadedMedia });
                    }
                } else {
                    // إضافة إعلان جديد
                    existingAds.push({ ...adData, media: uploadedMedia });
                }

                localStorage.setItem(storageKey, JSON.stringify(existingAds));
                
                if (isPublish) {
                    // إخفاء رسالة الانتظار
                    hideWaitingMessage();
                    
                    // عرض رسالة النجاح
                    const successMsg = document.getElementById('successMessage');
                    if (isEditMode) {
                        successMsg.querySelector('span').textContent = '✅ تم تحديث الإعلان بنجاح!';
                    } else {
                        successMsg.querySelector('span').textContent = '✅ تم نشر الإعلان بنجاح! تم خصم 10 نقاط من رصيدك';
                    }
                    successMsg.classList.add('active');
                    setTimeout(() => {
                        successMsg.classList.remove('active');
                    }, 3000);
                    
                    // تنظيف بيانات التعديل من localStorage
                    localStorage.removeItem('editAdId');
                    localStorage.removeItem('editAdCategory');
                    localStorage.removeItem('editAdDate');
                    localStorage.removeItem('editAdFirebaseId');
                    localStorage.removeItem('editAdData');
                    
                    // الانتقال إلى صفحة الإعلانات بعد ثانيتين
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                    
                } else {
                    // رسالة الحفظ كمسودة
                    const message = isEditMode ? 'تم تحديث الإعلان كمسودة بنجاح!' : 'تم حفظ الإعلان كمسودة';
                    const successMsg = document.getElementById('successMessage');
                    successMsg.querySelector('span').textContent = message;
                    successMsg.classList.add('active');
                    setTimeout(() => {
                        successMsg.classList.remove('active');
                    }, 1500);
                }
            } catch (e) {
                // إخفاء رسالة الانتظار في حالة الخطأ
                if (isPublish) {
                    hideWaitingMessage();
                }
                
                console.error("❌ خطأ في حفظ الإعلان:", e);
                showError('حدث خطأ أثناء حفظ الإعلان: ' + e.message);
            }
        }
        
        // إضافة مستمعي الأحداث للأزرار
        


        
        
       

        
        
        
    </script>

</body>
</html>
